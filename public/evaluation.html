<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SIRA - ƒê√°nh gi√°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    .badge { padding: 6px 12px; border-radius: 999px; font-weight: 600; font-size: 12px; }
    .badge.emp { background: #e3f2fd; color: #1565c0; }
    .badge.mgr { background: #fff3e0; color: #ef6c00; }
    .info { margin: 8px 0; color: #444; }
    .criteria-group { border: 1px solid #e5e7eb; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    .criteria-group h3 { margin: 0 0 8px 0; color: #333; }
    .criterion { padding: 10px 0; border-bottom: 1px solid #f1f3f5; display: flex; align-items: center; gap: 12px; justify-content: space-between; }
    .criterion:last-child { border-bottom: none; }
    .criterion label { flex: 1; color: #333; font-weight: 600; }

    .radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .radio-option { display: inline-flex; align-items: center; gap: 6px; background: #f7f8fb; padding: 6px 10px; border-radius: 8px; border: 1px solid #e5e7eb; cursor: pointer; user-select: none; }
    .radio-option input { margin: 0; }
    .radio-option:hover { border-color: #667eea; }
    textarea { width: 100%; min-height: 100px; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .actions { display: flex; gap: 10px; margin-top: 20px; }
    button { cursor: pointer; border: none; border-radius: 8px; padding: 12px 16px; font-size: 14px; font-weight: 600; }
    .btn-primary { background: #667eea; color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #333; }
    .loading { text-align: center; padding: 30px; color: #666; }
    .error { background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .success { background: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    .back-button { background: none; border: none; color: #667eea; font-size: 18px; cursor: pointer; padding: 8px; font-weight: 600; }
    #evaluationTitle { margin: 0; color: #333; font-size: 28px; font-weight: 700; flex: 1; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
      <button class="back-button" onclick="window.location.href='dashboard.html'" title="Quay l·∫°i Dashboard">‚Üê Quay l·∫°i</button>
      <h1 id="evaluationTitle"></h1>
    </div>

    <div class="header">
      <div>
        <h3 style="margin:0">Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°</h3>
        <div id="revieweeInfo" class="info"></div>
      </div>
    </div>

    <div id="messageBox" style="margin-bottom: 16px;"></div>

    <form id="form" style="display:none">
      <div id="criteriaContainer"></div>

      <div style="margin-top:16px;">
        <label for="comments" style="font-weight:600; color:#333;">Nh·∫≠n x√©t b·ªï sung <span style="color:red;">*</span></label>
        <textarea id="comments" placeholder="# ∆Øu ƒëi·ªÉm&#10;...&#10;# Nh∆∞·ª£c ƒëi·ªÉm&#10;...&#10;# K·ª≥ v·ªçng" required></textarea>
        <div id="commentsError" style="color:#c62828; font-size:13px; margin-top:4px; display:none;"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn-secondary" onclick="history.back()">Quay l·∫°i</button>
        <button type="submit" class="btn-primary">L∆∞u ƒë√°nh gi√°</button>
      </div>
    </form>
  </div>

  <script src="js/config.js"></script>
  
  <!-- Auto cache busting -->
  <script>
    (function() {
      const CURRENT_VERSION = window.SIRA_CONFIG.VERSION;
      const storedVersion = localStorage.getItem('app_version');
      
      if (storedVersion && storedVersion !== CURRENT_VERSION) {
        console.log('üîÑ Ph√°t hi·ªán phi√™n b·∫£n m·ªõi (' + CURRENT_VERSION + '), ƒëang l√†m m·ªõi cache...');
        localStorage.setItem('app_version', CURRENT_VERSION);
        location.reload(true);
      } else {
        localStorage.setItem('app_version', CURRENT_VERSION);
      }
    })();

    // Ki·ªÉm tra mode (view ho·∫∑c edit, default l√† edit)
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode') || 'edit';
    const isViewMode = mode === 'view';
    const isEditMode = mode === 'edit';
  </script>
  
  <script type="module">
    const messageBox = document.getElementById('messageBox');
    const formEl = document.getElementById('form');
    const criteriaContainer = document.getElementById('criteriaContainer');
    const revieweeInfo = document.getElementById('revieweeInfo');
    const evaluationTitle = document.getElementById('evaluationTitle');

    // T·∫°o statusBox v√† loading ƒë·ªông
    const statusBox = document.createElement('div');
    statusBox.id = 'statusBox';
    statusBox.className = 'error';
    statusBox.style.display = 'none';
    messageBox.appendChild(statusBox);

    const loading = document.createElement('div');
    loading.id = 'loading';
    loading.className = 'loading';
    loading.textContent = 'ƒêang t·∫£i ti√™u ch√≠...';
    loading.style.display = 'none';
    messageBox.appendChild(loading);

    function showError(msg) {
      statusBox.textContent = msg;
      statusBox.className = 'error';
      statusBox.style.display = 'block';
      statusBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    function showSuccess(msg) {
      statusBox.textContent = msg;
      statusBox.className = 'success';
      statusBox.style.display = 'block';
      statusBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function getAssignment() {
      // N·∫øu c√≥ URL query parameters (mode=view ho·∫∑c mode=edit), l·∫•y t·ª´ URL
      if (isViewMode || isEditMode) {
        const reviewer_email = urlParams.get('reviewer_email');
        const reviewee_email = urlParams.get('reviewee_email');
        const target_type = urlParams.get('target_type');
        
        if (reviewer_email && reviewee_email && target_type) {
          return {
            reviewer_email: reviewer_email,
            reviewee_email: reviewee_email,
            target_type: target_type,
            reviewee: {
              email: reviewee_email,
              name: '',
              department: '',
              position: ''
            }
          };
        }
      }
      
      // Fallback: l·∫•y t·ª´ sessionStorage (c√°ch c≈©, kh√¥ng khuy·∫øn ngh·ªã)
      const raw = sessionStorage.getItem('currentAssignment');
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }

    async function loadRevieweeInfo(assignment) {
      try {
        const result = await window.SIRA_API.lookupEmployee(assignment.reviewee_email);
        console.log('loadRevieweeInfo result:', result);
        if (result.success && result.employee) {
          assignment.reviewee.name = result.employee.name || assignment.reviewee.email;
          assignment.reviewee.department = result.employee.department || '';
          assignment.reviewee.position = result.employee.position || '';
          console.log('Reviewee info loaded:', assignment.reviewee);
        }
      } catch (err) {
        console.error('Error loading reviewee info:', err);
        assignment.reviewee.name = assignment.reviewee.email;
      }
    }

    function renderAssignmentInfo(assignment) {
      const r = assignment.reviewee;
      revieweeInfo.textContent = `${r.name} ‚Ä¢ ${r.department} ‚Ä¢ ${r.position} ‚Ä¢ ${r.email}`;
      if (assignment.target_type === 'EMPLOYEE') {
        evaluationTitle.textContent = 'B·ªô ƒë√°nh gi√° Nh√¢n vi√™n';
      } else {
        evaluationTitle.textContent = 'B·ªô ƒë√°nh gi√° Qu·∫£n l√Ω';
      }
    }

    function renderScale(maxValue = 5, criteriaId) {
      const max = Number(maxValue) > 0 ? Number(maxValue) : 5;
      let radios = '';
      for (let i = 1; i <= max; i++) {
        const id = `c_${criteriaId}_${i}`;
        radios += `
          <label class="radio-option">
            <input type="radio" name="c_${criteriaId}" value="${i}" data-criteria-id="${criteriaId}" id="${id}" />
            <span>${i}</span>
          </label>
        `;
      }
      return `<div class="radio-group">${radios}</div>`;
    }

    function renderCriteria(criteria, targetType) {
      criteriaContainer.innerHTML = '';
      if (targetType === 'EMPLOYEE') {
        criteria.forEach(cat => {
          const group = document.createElement('div');
          group.className = 'criteria-group';
          group.innerHTML = `<h3>${cat.title || cat.name || cat.criteria_name || cat.criteria_id}</h3>`;
          (cat.sub_criteria || []).forEach(item => {
            const row = document.createElement('div');
            row.className = 'criterion';
            row.innerHTML = `
              <label>${item.title || item.name || item.criteria_name || item.criteria_id}</label>
              ${renderScale(item.max_value, item.criteria_id)}
            `;
            group.appendChild(row);
          });
          criteriaContainer.appendChild(group);
        });
      } else {
        const group = document.createElement('div');
        group.className = 'criteria-group';
        group.innerHTML = '<h3>Ti√™u ch√≠</h3>';
        criteria.forEach(item => {
          const row = document.createElement('div');
          row.className = 'criterion';
          row.innerHTML = `
            <label>${item.title || item.name || item.criteria_name || item.criteria_id}</label>
            ${renderScale(item.max_value, item.criteria_id)}
          `;
          group.appendChild(row);
        });
        criteriaContainer.appendChild(group);
      }
    }

    async function loadCriteria(assignment) {
      loading.style.display = 'block';
      formEl.style.display = 'none';
      statusBox.style.display = 'none';
      try {
        const data = await window.SIRA_API.getCriteria(assignment.target_type);
        if (!data.success) {
          showError(data.error || 'Kh√¥ng th·ªÉ t·∫£i ti√™u ch√≠');
          return;
        }
        renderCriteria(data.criteria, assignment.target_type);
        formEl.style.display = 'block';
      } catch (err) {
        console.error(err);
        showError('L·ªói t·∫£i ti√™u ch√≠: ' + err.message);
      } finally {
        loading.style.display = 'none';
      }
      
    }

    function collectScores() {
      const radios = criteriaContainer.querySelectorAll('input[type="radio"][data-criteria-id]');
      const byCriteria = new Map();
      for (const radio of radios) {
        const cid = radio.getAttribute('data-criteria-id');
        if (radio.checked) {
          byCriteria.set(cid, Number(radio.value));
        }
      }

      const scores = [];
      // Ensure every criteria has a selection
      const criteriaIds = new Set();
      radios.forEach(r => criteriaIds.add(r.getAttribute('data-criteria-id')));
      for (const cid of criteriaIds) {
        if (!byCriteria.has(cid)) {
          // T√¨m ti√™u ch√≠ ch∆∞a ch·ªçn v√† scroll ƒë·∫øn ƒë√≥
          const firstUnscored = Array.from(radios).find(r => r.getAttribute('data-criteria-id') === cid);
          if (firstUnscored) {
            const criterionRow = firstUnscored.closest('.criterion');
            if (criterionRow) {
              criterionRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              criterionRow.style.background = '#fff3cd';
              setTimeout(() => { criterionRow.style.background = ''; }, 2000);
            }
          }
          throw new Error('Vui l√≤ng ch·ªçn ƒëi·ªÉm cho t·∫•t c·∫£ ti√™u ch√≠.');
        }
        scores.push({ criteria_id: cid, score: byCriteria.get(cid) });
      }
      return scores;
    }

    async function submitEvaluation(evt) {
      evt.preventDefault();
      statusBox.style.display = 'none';
      const assignment = getAssignment();
      if (!assignment) {
        showError('Kh√¥ng t√¨m th·∫•y assignment.');
        return;
      }
      if (!assignment.reviewer_email || !assignment.reviewee_email || !assignment.target_type) {
        showError('Th√¥ng tin email ho·∫∑c lo·∫°i ƒë√°nh gi√° kh√¥ng ƒë·∫ßy ƒë·ªß.');
        return;
      }
      try {
        const criteria_scores = collectScores();
        const comments = (document.getElementById('comments').value || '').trim();
        const commentsError = document.getElementById('commentsError');
        
        // Validate comments
        if (!comments) {
          commentsError.textContent = '‚ùå Nh·∫≠n x√©t b·ªï sung l√† b·∫Øt bu·ªôc';
          commentsError.style.display = 'block';
          document.getElementById('comments').scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
        if (comments.length < 80) {
          commentsError.textContent = `‚ùå Nh·∫≠n x√©t ph·∫£i t·ªëi thi·ªÉu 80 k√Ω t·ª± (hi·ªán c√≥ ${comments.length}/80)`;
          commentsError.style.display = 'block';
          document.getElementById('comments').scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
        commentsError.style.display = 'none';
        
        const result = await window.SIRA_API.saveEvaluation(
          assignment.reviewer_email,
          assignment.reviewee_email,
          assignment.target_type,
          criteria_scores,
          comments
        );
        if (!result.success) {
          showError(result.error || 'L∆∞u ƒë√°nh gi√° th·∫•t b·∫°i');
          return;
        }
        showSuccess('ƒê√£ l∆∞u ƒë√°nh gi√° th√†nh c√¥ng.');
        setTimeout(() => { window.location.href = 'dashboard.html'; }, 800);
      } catch (err) {
        showError(err.message || 'C√≥ l·ªói x·∫£y ra');
      }
    }

    document.getElementById('form').addEventListener('submit', submitEvaluation);

    // Kh·ªüi t·∫°o trang
    (async function init() {
      const assignment = getAssignment();
      if (!assignment) {
        showError('Kh√¥ng c√≥ assignment trong phi√™n. Quay l·∫°i danh s√°ch.');
        setTimeout(() => { window.location.href = 'dashboard.html'; }, 800);
        return;
      }
      // T·∫£i th√¥ng tin ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° n·∫øu ·ªü ch·∫ø ƒë·ªô view ho·∫∑c edit
      if (isViewMode || isEditMode) {
        await loadRevieweeInfo(assignment);
      }
      // Hi·ªÉn th·ªã notifier n·∫øu ·ªü ch·∫ø ƒë·ªô view
      if (isViewMode) {
        const viewIndicator = document.createElement('div');
        viewIndicator.style.cssText = 'background: #e3f2fd; border: 1px solid #2196f3; padding: 10px; border-radius: 8px; margin-bottom: 16px; color: #1565c0; display: flex; align-items: center; gap: 8px;';
        viewIndicator.innerHTML = `<span>üîç</span><strong>Ch·∫ø ƒë·ªô xem - Kh√¥ng th·ªÉ ch·ªânh s·ª≠a</strong>`;
        messageBox.insertBefore(viewIndicator, messageBox.firstChild);
      }

      renderAssignmentInfo(assignment);
      await loadCriteria(assignment);

      // Check xem ƒë√£ c√≥ evaluation tr∆∞·ªõc ƒë√≥ kh√¥ng (re-evaluation case)
      if (assignment.reviewer_email && assignment.reviewee_email && assignment.target_type) {
        try {
          console.log('DEBUG: Calling getEvaluation with:', {
            reviewer_email: assignment.reviewer_email,
            reviewee_email: assignment.reviewee_email,
            target_type: assignment.target_type,
            isViewMode: isViewMode
          });
          
          const result = await window.SIRA_API.getEvaluation(
            assignment.reviewer_email,
            assignment.reviewee_email,
            assignment.target_type
          );
          
          console.log('DEBUG: getEvaluation result:', result);
          
          if (result.success && result.exists) {
            console.log('Found existing evaluation:', result);
            
            // Pre-fill scores
            if (result.criteria_scores && result.criteria_scores.length > 0) {
              console.log('Pre-filling scores:', result.criteria_scores);
              result.criteria_scores.forEach(item => {
                // Radio name format: c_{criteriaId}
                const radio = document.querySelector(`input[name="c_${item.criteria_id}"][value="${item.score}"]`);
                console.log(`Looking for input[name="c_${item.criteria_id}"][value="${item.score}"]`, radio ? 'FOUND' : 'NOT FOUND');
                if (radio) {
                  radio.checked = true;
                }
              });
            }

            // Pre-fill comments
            if (result.comments) {
              document.getElementById('comments').value = result.comments;
            }

            // Show re-evaluation indicator
            const indicator = document.createElement('div');
            indicator.style.cssText = 'background: #fff3cd; border: 1px solid #ffc107; padding: 10px; border-radius: 8px; margin-bottom: 16px; color: #856404;';
            indicator.innerHTML = `<strong>üìù ƒêang ch·ªânh s·ª≠a ƒë√°nh gi√° tr∆∞·ªõc</strong><br>B·∫°n ƒë√£ ƒë√°nh gi√° ng∆∞·ªùi n√†y v√†o ${result.evaluation_date || 'tr∆∞·ªõc ƒë√≥'}. G·ª≠i l·∫°i s·∫Ω c·∫≠p nh·∫≠t ƒë√°nh gi√°.`;
            messageBox.appendChild(indicator);
          } else {
            console.log('DEBUG: No existing evaluation found or API error');
          }
        } catch (err) {
          console.error('Error loading existing evaluation:', err);
          // Kh√¥ng hi·ªÉn th·ªã l·ªói cho user, ti·∫øp t·ª•c v·ªõi form tr·ªëng
        }
      }

      // N·∫øu mode view, disable t·∫•t c·∫£ inputs v√† ·∫©n submit button
      if (isViewMode) {
        // Disable t·∫•t c·∫£ input radio
        const radios = document.querySelectorAll('input[type="radio"]');
        radios.forEach(radio => radio.disabled = true);

        // Disable textarea comments
        const comments = document.getElementById('comments');
        if (comments) comments.disabled = true;

        // ·∫®n button submit, ch·ªâ gi·ªØ "Quay l·∫°i"
        const actions = document.querySelector('.actions');
        if (actions) {
          const submitBtn = actions.querySelector('button[type="submit"]');
          if (submitBtn) submitBtn.style.display = 'none';
        }
      }
    })();
  </script>
</body>
</html>
