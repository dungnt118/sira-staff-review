<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIRA - H·ªá th·ªëng ƒê√°nh gi√° Nh√¢n vi√™n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 30px;
            margin: 20px 0;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-form {
            text-align: center;
        }

        .input-group {
            margin: 20px 0;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .user-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .assignments-grid {
            display: grid;
            gap: 20px;
        }

        .assignment-card {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .assignment-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .assignment-card.completed {
            border-color: #28a745;
            background: #f8fff9;
        }

        .assignment-card.pending {
            border-color: #ffc107;
            background: #fffdf8;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .criteria-section {
            margin: 20px 0;
        }

        .criteria-category {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .criteria-category-header {
            background: #f8f9fa;
            padding: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .criteria-category-content {
            display: none;
            padding: 15px;
        }

        .criteria-category.expanded .criteria-category-content {
            display: block;
        }

        .criteria-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
        }

        .score-input {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }

        .score-radio {
            margin: 0 5px;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .evaluation-form {
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px 0;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ SIRA VI·ªÜT NAM</h1>
            <p>H·ªá th·ªëng ƒê√°nh gi√° Nh√¢n vi√™n 2025</p>
        </div>

        <!-- Login Form -->
        <div id="loginSection" class="card">
            <div class="login-form">
                <h2>üîê ƒêƒÉng nh·∫≠p</h2>
                <div class="input-group">
                    <label for="emailInput">Email c·ªßa b·∫°n:</label>
                    <input type="email" id="emailInput" placeholder="nhap.email@sira.vn" />
                </div>
                <button class="btn" onclick="login()">ƒêƒÉng nh·∫≠p</button>
                <div id="loginError" class="error hidden"></div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboardSection" class="hidden">
            <!-- User Info -->
            <div class="card">
                <div id="userInfo" class="user-info">
                    <h3>üëã Xin ch√†o, <span id="userName"></span></h3>
                    <p><strong>Ph√≤ng ban:</strong> <span id="userDepartment"></span></p>
                    <p><strong>Ch·ª©c v·ª•:</strong> <span id="userPosition"></span></p>
                    <button class="btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <!-- Assignments List -->
            <div class="card">
                <h2>üìã Danh s√°ch c·∫ßn ƒë√°nh gi√°</h2>
                <div id="assignmentsLoading" class="loading">
                    <p>üîÑ ƒêang t·∫£i danh s√°ch...</p>
                </div>
                <div id="assignmentsList" class="assignments-grid hidden"></div>
                <div id="assignmentsError" class="error hidden"></div>
            </div>
        </div>

        <!-- Evaluation Form -->
        <div id="evaluationSection" class="card hidden">
            <h2>üìù ƒê√°nh gi√°: <span id="evaluationTitle"></span></h2>
            <div id="evaluationInfo" class="user-info"></div>
            
            <div id="evaluationForm" class="evaluation-form">
                <div id="criteriaLoading" class="loading">
                    <p>üîÑ ƒêang t·∫£i ti√™u ch√≠ ƒë√°nh gi√°...</p>
                </div>
                <div id="criteriaContainer" class="criteria-section hidden"></div>
                
                <div class="input-group">
                    <label for="evaluationComments">Nh·∫≠n x√©t chi ti·∫øt:</label>
                    <textarea id="evaluationComments" rows="4" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;" 
                              placeholder="Vui l√≤ng nh·∫≠p nh·∫≠n x√©t chi ti·∫øt v·ªÅ hi·ªáu su·∫•t l√†m vi·ªác..."></textarea>
                </div>

                <div id="evaluationError" class="error hidden"></div>
            </div>

            <div class="form-actions">
                <button class="btn" onclick="goBack()">‚Üê Quay l·∫°i</button>
                <button class="btn" id="submitBtn" onclick="submitEvaluation()" disabled>üíæ L∆∞u ƒë√°nh gi√°</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentAssignment = null;
        let allCriteria = [];
        let scores = {};

        // Utility functions
        const API_BASE = window.location.origin;

        function showSection(sectionId) {
            ['loginSection', 'dashboardSection', 'evaluationSection'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
        }

        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
            setTimeout(() => errorEl.classList.add('hidden'), 5000);
        }

        function showLoading(elementId, show = true) {
            const loadingEl = document.getElementById(elementId);
            if (show) {
                loadingEl.classList.remove('hidden');
            } else {
                loadingEl.classList.add('hidden');
            }
        }

        // Authentication
        async function login() {
            const email = document.getElementById('emailInput').value.trim();
            if (!email) {
                showError('loginError', 'Vui l√≤ng nh·∫≠p email');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/login?email=${encodeURIComponent(email)}`);
                const data = await response.json();

                if (data.success) {
                    currentUser = data.employee;
                    document.getElementById('userName').textContent = currentUser.name;
                    document.getElementById('userDepartment').textContent = currentUser.department;
                    document.getElementById('userPosition').textContent = currentUser.position;
                    
                    showSection('dashboardSection');
                    await loadAssignments();
                } else {
                    showError('loginError', data.error || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i');
                }
            } catch (error) {
                showError('loginError', 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                console.error('Login error:', error);
            }
        }

        function logout() {
            currentUser = null;
            currentAssignment = null;
            scores = {};
            document.getElementById('emailInput').value = '';
            showSection('loginSection');
        }

        // Load assignments
        async function loadAssignments() {
            showLoading('assignmentsLoading', true);
            document.getElementById('assignmentsList').classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/my-assignments?reviewer_email=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();

                if (data.success) {
                    displayAssignments(data.assignments);
                } else {
                    showError('assignmentsError', data.error || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë√°nh gi√°');
                }
            } catch (error) {
                showError('assignmentsError', 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                console.error('Load assignments error:', error);
            } finally {
                showLoading('assignmentsLoading', false);
            }
        }

        function displayAssignments(assignments) {
            const container = document.getElementById('assignmentsList');
            
            if (assignments.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">üìù B·∫°n kh√¥ng c√≥ ƒë√°nh gi√° n√†o c·∫ßn th·ª±c hi·ªán.</p>';
            } else {
                container.innerHTML = assignments.map(assignment => `
                    <div class="assignment-card ${assignment.status.toLowerCase()}" onclick="startEvaluation('${assignment.assignment_id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3>${assignment.reviewee.name}</h3>
                            <span class="status-badge status-${assignment.status.toLowerCase()}">${assignment.status}</span>
                        </div>
                        <p><strong>Ph√≤ng ban:</strong> ${assignment.reviewee.department}</p>
                        <p><strong>Ch·ª©c v·ª•:</strong> ${assignment.reviewee.position}</p>
                        <p><strong>Lo·∫°i ƒë√°nh gi√°:</strong> ${assignment.target_type === 'EMPLOYEE' ? 'Nh√¢n vi√™n' : 'Qu·∫£n l√Ω'}</p>
                        <p style="margin-top: 10px; font-style: italic; color: #666;">
                            ${assignment.status === 'COMPLETED' ? '‚úÖ ƒê√£ ho√†n th√†nh' : '‚è≥ Nh·∫•p ƒë·ªÉ b·∫Øt ƒë·∫ßu ƒë√°nh gi√°'}
                        </p>
                    </div>
                `).join('');
            }

            container.classList.remove('hidden');
        }

        // Start evaluation
        async function startEvaluation(assignmentId) {
            // Find assignment
            const response = await fetch(`${API_BASE}/my-assignments?reviewer_email=${encodeURIComponent(currentUser.email)}`);
            const data = await response.json();
            currentAssignment = data.assignments.find(a => a.assignment_id === assignmentId);

            if (!currentAssignment) {
                alert('Kh√¥ng t√¨m th·∫•y ƒë√°nh gi√° n√†y.');
                return;
            }

            if (currentAssignment.status === 'COMPLETED') {
                alert('ƒê√°nh gi√° n√†y ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh.');
                return;
            }

            // Show evaluation section
            document.getElementById('evaluationTitle').textContent = currentAssignment.reviewee.name;
            document.getElementById('evaluationInfo').innerHTML = `
                <p><strong>üë§ Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°:</strong> ${currentAssignment.reviewee.name}</p>
                <p><strong>üè¢ Ph√≤ng ban:</strong> ${currentAssignment.reviewee.department}</p>
                <p><strong>üíº Ch·ª©c v·ª•:</strong> ${currentAssignment.reviewee.position}</p>
                <p><strong>üìã Lo·∫°i ƒë√°nh gi√°:</strong> ${currentAssignment.target_type === 'EMPLOYEE' ? 'Nh√¢n vi√™n' : 'Qu·∫£n l√Ω'}</p>
            `;

            showSection('evaluationSection');
            await loadCriteria();
        }

        // Load criteria
        async function loadCriteria() {
            showLoading('criteriaLoading', true);
            document.getElementById('criteriaContainer').classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE}/getCriteriaAPI?target_type=${currentAssignment.target_type}`);
                const data = await response.json();

                if (data.success) {
                    allCriteria = data.criteria;
                    displayCriteria();
                } else {
                    showError('evaluationError', data.error || 'Kh√¥ng th·ªÉ t·∫£i ti√™u ch√≠ ƒë√°nh gi√°');
                }
            } catch (error) {
                showError('evaluationError', 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                console.error('Load criteria error:', error);
            } finally {
                showLoading('criteriaLoading', false);
            }
        }

        function displayCriteria() {
            const container = document.getElementById('criteriaContainer');
            scores = {};

            if (currentAssignment.target_type === 'EMPLOYEE') {
                // Hi·ªÉn th·ªã c√≥ ph√¢n c·∫•p
                container.innerHTML = allCriteria.map(category => `
                    <div class="criteria-category" id="category-${category.criteria_id}">
                        <div class="criteria-category-header" onclick="toggleCategory(${category.criteria_id})">
                            <span><strong>${category.criteria_name}</strong></span>
                            <span>‚ñº</span>
                        </div>
                        <div class="criteria-category-content">
                            <p style="margin-bottom: 15px; color: #666;">${category.description}</p>
                            ${category.sub_criteria.map(criterion => `
                                <div class="criteria-item">
                                    <h4>${criterion.criteria_name}</h4>
                                    <p style="margin: 5px 0; color: #666; font-size: 14px;">${criterion.description}</p>
                                    <div class="score-input">
                                        <span>ƒêi·ªÉm ƒë√°nh gi√°:</span>
                                        <label class="score-radio"><input type="radio" name="criteria_${criterion.criteria_id}" value="1" onchange="updateScore(${criterion.criteria_id}, 1)"> ƒê·∫°t y√™u c·∫ßu (1)</label>
                                        <label class="score-radio"><input type="radio" name="criteria_${criterion.criteria_id}" value="2" onchange="updateScore(${criterion.criteria_id}, 2)"> T·ªët (2)</label>
                                        <label class="score-radio"><input type="radio" name="criteria_${criterion.criteria_id}" value="3" onchange="updateScore(${criterion.criteria_id}, 3)"> Xu·∫•t s·∫Øc (3)</label>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            } else {
                // Manager - hi·ªÉn th·ªã ph·∫≥ng
                container.innerHTML = `
                    <div class="criteria-category expanded">
                        <div class="criteria-category-content">
                            ${allCriteria.map(criterion => `
                                <div class="criteria-item">
                                    <h4>${criterion.criteria_name}</h4>
                                    <p style="margin: 5px 0; color: #666; font-size: 14px;">${criterion.description}</p>
                                    <div class="score-input">
                                        <span>ƒêi·ªÉm ƒë√°nh gi√°:</span>
                                        <label class="score-radio"><input type="radio" name="criteria_${criterion.criteria_id}" value="1" onchange="updateScore(${criterion.criteria_id}, 1)"> 1 ƒëi·ªÉm</label>
                                        <label class="score-radio"><input type="radio" name="criteria_${criterion.criteria_id}" value="2" onchange="updateScore(${criterion.criteria_id}, 2)"> 2 ƒëi·ªÉm</label>
                                        <label class="score-radio"><input type="radio" name="criteria_${criterion.criteria_id}" value="3" onchange="updateScore(${criterion.criteria_id}, 3)"> 3 ƒëi·ªÉm</label>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            container.classList.remove('hidden');
        }

        function toggleCategory(categoryId) {
            const category = document.getElementById(`category-${categoryId}`);
            category.classList.toggle('expanded');
        }

        function updateScore(criteriaId, score) {
            scores[criteriaId] = score;
            checkFormCompletion();
        }

        function checkFormCompletion() {
            let totalCriteria = 0;
            
            if (currentAssignment.target_type === 'EMPLOYEE') {
                allCriteria.forEach(category => {
                    totalCriteria += category.sub_criteria.length;
                });
            } else {
                totalCriteria = allCriteria.length;
            }

            const completedScores = Object.keys(scores).length;
            const submitBtn = document.getElementById('submitBtn');
            
            if (completedScores === totalCriteria) {
                submitBtn.disabled = false;
                submitBtn.textContent = `üíæ L∆∞u ƒë√°nh gi√° (${completedScores}/${totalCriteria})`;
            } else {
                submitBtn.disabled = true;
                submitBtn.textContent = `üìù Ho√†n th√†nh ƒë√°nh gi√° (${completedScores}/${totalCriteria})`;
            }
        }

        // Submit evaluation
        async function submitEvaluation() {
            const comments = document.getElementById('evaluationComments').value.trim();
            
            if (Object.keys(scores).length === 0) {
                showError('evaluationError', 'Vui l√≤ng ch·∫•m ƒëi·ªÉm cho t·∫•t c·∫£ ti√™u ch√≠.');
                return;
            }

            const criteriaScores = Object.entries(scores).map(([criteriaId, score]) => ({
                criteria_id: parseInt(criteriaId),
                score: parseInt(score)
            }));

            try {
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').textContent = '‚è≥ ƒêang l∆∞u...';

                const response = await fetch(`${API_BASE}/evaluation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        assignment_id: currentAssignment.assignment_id,
                        criteria_scores: criteriaScores,
                        comments: comments
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!');
                    goBack();
                    await loadAssignments(); // Refresh assignments list
                } else {
                    showError('evaluationError', data.error || 'Kh√¥ng th·ªÉ l∆∞u ƒë√°nh gi√°');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = 'üíæ L∆∞u ƒë√°nh gi√°';
                }
            } catch (error) {
                showError('evaluationError', 'L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'üíæ L∆∞u ƒë√°nh gi√°';
                console.error('Submit evaluation error:', error);
            }
        }

        function goBack() {
            currentAssignment = null;
            scores = {};
            showSection('dashboardSection');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('emailInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
        });
    </script>
</body>
</html>