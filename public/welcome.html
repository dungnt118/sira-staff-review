<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Dashboard - SIRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header h1 {
      font-size: 24px;
      color: #333;
      margin: 0;
    }

    .header-right {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-admin {
      background: #ffb300;
      color: #4a2c00;
    }

    .btn-admin:hover {
      background: #ffa000;
    }

    .btn-danger {
      background: #ff5252;
      color: white;
    }

    .btn-danger:hover {
      background: #ff3838;
    }

    .assignments-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .assignments-section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #667eea;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 20px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #c62828;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .assignments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .assignment-card {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s;
      cursor: pointer;
      background: white;
    }

    .assignment-card:hover {
      border-color: #667eea;
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .assignment-card.completed {
      border-color: #4caf50;
      background: #f1f8e9;
    }

    .assignment-card.pending {
      border-color: #ff9800;
      background: #fff3e0;
    }

    .assignment-card h3 {
      color: #333;
      margin-bottom: 10px;
    }

    .assignment-card p {
      color: #666;
      font-size: 14px;
      margin: 5px 0;
    }

    .assignment-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 10px;
      text-transform: uppercase;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .assignment-type {
      color: #667eea;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-right {
        width: 100%;
        flex-wrap: wrap;
      }

      .assignments-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>üìã Dashboard - Nhi·ªám v·ª• ƒë√°nh gi√°</h1>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" onclick="location.href='index.html'">üè† Trang ch·ªß</button>
        <button class="btn btn-admin hidden" id="adminReportBtn" onclick="location.href='reports.html'">üìä Xem b√°o c√°o</button>
        <button class="btn btn-admin hidden" id="adminAssignmentsBtn" onclick="location.href='assignments-manager.html'">üéØ Qu·∫£n l√Ω Assignments</button>
        <button class="btn btn-danger" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <!-- Assignments Section -->
    <div class="assignments-section">
      <h2>Danh s√°ch ƒë√°nh gi√° ƒë∆∞·ª£c ph√¢n c√¥ng</h2>

      <div id="loading" class="loading hidden">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i danh s√°ch...</p>
      </div>

      <div id="error" class="error hidden"></div>

      <div id="empty" class="empty-state hidden">
        <p>üìù B·∫°n kh√¥ng c√≥ nhi·ªám v·ª• ƒë√°nh gi√° n√†o c·∫ßn th·ª±c hi·ªán.</p>
      </div>

      <div id="assignments" class="assignments-grid"></div>
    </div>
  </div>

  <script src="js/config.js"></script>
  
  <!-- Auto cache busting -->
  <script>
    (function() {
      const CURRENT_VERSION = window.SIRA_CONFIG.VERSION;
      const storedVersion = localStorage.getItem('app_version');
      
      if (storedVersion && storedVersion !== CURRENT_VERSION) {
        console.log('üîÑ Ph√°t hi·ªán phi√™n b·∫£n m·ªõi (' + CURRENT_VERSION + '), ƒëang l√†m m·ªõi cache...');
        localStorage.setItem('app_version', CURRENT_VERSION);
        location.reload(true);
      } else {
        localStorage.setItem('app_version', CURRENT_VERSION);
      }
    })();
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const app = initializeApp(window.SIRA_CONFIG.FIREBASE);
    const auth = getAuth(app);

    // Ki·ªÉm tra x√°c th·ª±c
    function checkAuth() {
      const userData = localStorage.getItem('currentUser');
      if (!userData) {
        window.location.href = 'index.html';
        return null;
      }
      const parsed = JSON.parse(userData);
      if (parsed?.employee) {
        const cachedRole = sessionStorage.getItem('userRole');
        parsed.employee.role = (parsed.employee.role || cachedRole || 'USER').toUpperCase();
        sessionStorage.setItem('userRole', parsed.employee.role);
      }
      return parsed;
    }

    // ƒêƒÉng xu·∫•t
    window.logout = async function() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        try {
          await signOut(auth);
          localStorage.removeItem('currentUser');
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('C√≥ l·ªói khi ƒëƒÉng xu·∫•t: ' + error.message);
        }
      }
    };

    // Hi·ªÉn th·ªã l·ªói
    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.classList.remove('hidden');
      document.getElementById('loading').classList.add('hidden');
    }

    function showAdminButtonIfNeeded(userData) {
      const role = userData?.employee?.role || sessionStorage.getItem('userRole') || 'USER';
      const reportBtn = document.getElementById('adminReportBtn');
      const assignmentsBtn = document.getElementById('adminAssignmentsBtn');
      
      if (role.toUpperCase() === 'ADMIN') {
        if (reportBtn) reportBtn.classList.remove('hidden');
        if (assignmentsBtn) assignmentsBtn.classList.remove('hidden');
      } else {
        if (reportBtn) reportBtn.classList.add('hidden');
        if (assignmentsBtn) assignmentsBtn.classList.add('hidden');
      }
    }

    // T·∫£i danh s√°ch ƒë√°nh gi√°
    async function loadAssignments() {
      try {
        const userData = checkAuth();
        if (!userData) return;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('error').classList.add('hidden');
        document.getElementById('empty').classList.add('hidden');
        document.getElementById('assignments').innerHTML = '';

        console.log('Loading assignments for:', userData.auth.email);

        // G·ªçi API qua Firebase Functions
        const data = await window.SIRA_API.getMyAssignments(userData.auth.email);
        console.log('Assignments data:', data);

        document.getElementById('loading').classList.add('hidden');

        if (data.success && data.assignments && data.assignments.length > 0) {
          displayAssignments(data.assignments);
        } else if (data.success && (!data.assignments || data.assignments.length === 0)) {
          document.getElementById('empty').classList.remove('hidden');
        } else {
          showError(data.error || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë√°nh gi√°');
        }
      } catch (error) {
        console.error('Load assignments error:', error);
        showError('L·ªói: ' + error.message);
      }
    }

    // Hi·ªÉn th·ªã danh s√°ch ƒë√°nh gi√°
    function displayAssignments(assignments) {
      const container = document.getElementById('assignments');
      container.innerHTML = '';

      assignments.forEach(assignment => {
        const card = document.createElement('div');
        card.className = `assignment-card ${assignment.status.toLowerCase()}`;
        card.onclick = () => startEvaluation(assignment);

        const reviewee = assignment.reviewee;
        const statusClass = assignment.status === 'COMPLETED' ? 'status-completed' : 'status-pending';

        card.innerHTML = `
          <div class="assignment-type">
            ${assignment.target_type === 'EMPLOYEE' ? 'üë§ Nh√¢n vi√™n' : 'üëî Qu·∫£n l√Ω'}
          </div>
          <h3>${reviewee.name}</h3>
          <p><strong>Ph√≤ng ban:</strong> ${reviewee.department}</p>
          <p><strong>Ch·ª©c v·ª•:</strong> ${reviewee.position}</p>
          <p><strong>Email:</strong> ${reviewee.email}</p>
          <div class="assignment-status ${statusClass}">
            ${assignment.status === 'COMPLETED' ? '‚úÖ ƒê√£ ho√†n th√†nh' : '‚è≥ Ch∆∞a l√†m'}
          </div>
        `;

        container.appendChild(card);
      });
    }

    // B·∫Øt ƒë·∫ßu ƒë√°nh gi√°
    function startEvaluation(assignment) {
      if (assignment.status === 'COMPLETED') {
        alert('ƒê√°nh gi√° n√†y ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh r·ªìi!');
        return;
      }

      // L∆∞u assignment v√†o session (email-based model)
      sessionStorage.setItem('currentAssignment', JSON.stringify({
        reviewer_email: assignment.reviewer_email,
        reviewee_email: assignment.reviewee_email,
        target_type: assignment.target_type,
        reviewee: assignment.reviewee
      }));
      
      // Chuy·ªÉn ƒë·∫øn trang ƒë√°nh gi√°
      window.location.href = 'evaluation.html';
    }

    // Kh·ªüi t·∫°o trang
    document.addEventListener('DOMContentLoaded', function() {
      const userData = checkAuth();
      if (userData) {
        console.log('User:', userData);
        showAdminButtonIfNeeded(userData);
        loadAssignments();
      }
    });
  </script>
</body>

</html>