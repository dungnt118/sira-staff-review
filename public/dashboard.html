<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Dashboard - SIRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header h1 {
      margin: 0;
      color: #333;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    
    .nav-btn:hover {
      background: #1976D2;
    }
    
    .nav-btn.logout {
      background: #f44336;
    }
    
    .nav-btn.logout:hover {
      background: #d32f2f;
    }
    
    .main-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .section-title {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
      font-style: italic;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .assignments-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    }
    
    .assignment-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 20px;
      background: #f9f9f9;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .assignment-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .assignment-card.completed {
      background: #e8f5e8;
      border-color: #4CAF50;
    }
    
    .assignment-card.pending {
      background: #fff3e0;
      border-color: #ff9800;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .reviewee-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin: 0;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .status-completed {
      background: #4CAF50;
      color: white;
    }
    
    .status-pending {
      background: #ff9800;
      color: white;
    }
    
    .reviewee-info {
      margin-bottom: 15px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 14px;
    }
    
    .info-label {
      color: #666;
      font-weight: 500;
    }
    
    .info-value {
      color: #333;
    }
    
    .assignment-details {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    
    .assignment-details h4 {
      margin: 0 0 10px 0;
      color: #555;
    }
    
    .action-button {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      text-transform: uppercase;
      transition: background 0.3s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      margin-top: 10px;
    }
    
    .btn-review {
      background: #4CAF50;
      color: white;
    }
    
    .btn-review:hover {
      background: #45a049;
    }
    
    .btn-view {
      background: #2196F3;
      color: white;
    }
    
    .btn-view:hover {
      background: #1976D2;
    }
    
    .btn-disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      border-left: 4px solid #4CAF50;
    }
    
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .nav-buttons {
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .assignments-grid {
        grid-template-columns: 1fr;
      }
      
      .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 10px;
      }
      
      .stats-summary {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>üìã Dashboard - Nhi·ªám v·ª• ƒë√°nh gi√°</h1>
    <div class="nav-buttons">
      <a href="welcome.html" class="nav-btn">üè† Trang ch·ªß</a>
      <a href="reports.html" class="nav-btn" id="reportsLink" style="display: none;">üìä B√°o c√°o</a>
      <a href="assignments-manager.html" class="nav-btn" id="assignmentsLink" style="display: none;">üéØ Qu·∫£n l√Ω ƒê√°nh gi√°</a>
      <button class="nav-btn logout" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="main-content">
    <!-- Loading state -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>ƒêang t·∫£i danh s√°ch nhi·ªám v·ª• ƒë√°nh gi√°...</div>
    </div>

    <!-- Stats summary -->
    <div id="stats" class="stats-summary" style="display: none;">
      <div class="stat-card">
        <div class="stat-number" id="total-assignments">0</div>
        <div class="stat-label">T·ªïng nhi·ªám v·ª•</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completed-assignments">0</div>
        <div class="stat-label">ƒê√£ ho√†n th√†nh</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-assignments">0</div>
        <div class="stat-label">Ch·ªù th·ª±c hi·ªán</div>
      </div>
    </div>

    <!-- Main content -->
    <div id="content-area">
      <h2 class="section-title">Danh s√°ch ƒë√°nh gi√° ƒë∆∞·ª£c ph√¢n c√¥ng</h2>
      
      <!-- Assignments will be loaded here -->
      <div id="assignments-container"></div>
    </div>
  </div>

  <!-- Load config first -->
  <script src="js/config.js"></script>
  
  <!-- Auto cache busting: T·ª± ƒë·ªông reload n·∫øu ph√°t hi·ªán version m·ªõi -->
  <script>
    (function() {
      const CURRENT_VERSION = window.SIRA_CONFIG.VERSION;
      const storedVersion = localStorage.getItem('app_version');
      
      if (storedVersion && storedVersion !== CURRENT_VERSION) {
        console.log('üîÑ Ph√°t hi·ªán phi√™n b·∫£n m·ªõi (' + CURRENT_VERSION + '), ƒëang l√†m m·ªõi cache...');
        localStorage.setItem('app_version', CURRENT_VERSION);
        location.reload(true);
      } else {
        localStorage.setItem('app_version', CURRENT_VERSION);
      }
    })();
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const app = initializeApp(window.SIRA_CONFIG.FIREBASE);
    const auth = getAuth(app);

    // Ki·ªÉm tra authentication
    function checkAuth() {
      const savedUser = localStorage.getItem('currentUser');
      if (!savedUser) {
        alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. ƒêang chuy·ªÉn h∆∞·ªõng...');
        window.location.href = 'index.html';
        return null;
      }
      return JSON.parse(savedUser);
    }

    // Show admin links if user is admin
    function showAdminLinks(userData) {
      // Role ƒë∆∞·ª£c l∆∞u trong userData.employee.role
      const userRole = userData?.employee?.role || userData?.auth?.role || 'USER';
      if (userRole === 'ADMIN') {
        document.getElementById('reportsLink').style.display = 'inline-block';
        document.getElementById('assignmentsLink').style.display = 'inline-block';
      }
    }

    // ƒêƒÉng xu·∫•t
    window.logout = async function() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        try {
          await signOut(auth);
          localStorage.removeItem('currentUser');
          window.location.href = 'index.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('C√≥ l·ªói khi ƒëƒÉng xu·∫•t: ' + error.message);
        }
      }
    };

    // Load danh s√°ch ƒë√°nh gi√°
    async function loadAssignments() {
      const userData = checkAuth();
      if (!userData) return;

      // Show admin links if applicable
      showAdminLinks(userData);

      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('stats').style.display = 'none';

        const result = await window.SIRA_API.getAssignments(userData.auth.email);

        if (result.success) {
          displayAssignments(result.assignments);
          updateStats(result.assignments);
        } else {
          throw new Error(result.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch ƒë√°nh gi√°');
        }

      } catch (error) {
        console.error('Load assignments error:', error);
        document.getElementById('assignments-container').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <h3>C√≥ l·ªói x·∫£y ra</h3>
            <p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch nhi·ªám v·ª• ƒë√°nh gi√°.</p>
            <p><strong>L·ªói:</strong> ${error.message}</p>
            <button onclick="location.reload()" class="action-button btn-review" style="max-width: 200px; margin: 20px auto;">
              üîÑ Th·ª≠ l·∫°i
            </button>
          </div>
        `;
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    // Hi·ªÉn th·ªã danh s√°ch ƒë√°nh gi√°
    function displayAssignments(assignments) {
      const container = document.getElementById('assignments-container');

      if (!assignments || assignments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <h3>Ch∆∞a c√≥ nhi·ªám v·ª• ƒë√°nh gi√°</h3>
            <p>Hi·ªán t·∫°i b·∫°n ch∆∞a ƒë∆∞·ª£c ph√¢n c√¥ng ƒë√°nh gi√° nh√¢n vi√™n n√†o.</p>
            <p>Vui l√≤ng li√™n h·ªá v·ªõi b·ªô ph·∫≠n HR ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.</p>
          </div>
        `;
        return;
      }

      const assignmentsHTML = assignments.map(assignment => {
        // Map status to completed boolean
        const isCompleted = assignment.status === 'COMPLETED';
        const statusClass = isCompleted ? 'completed' : 'pending';
        const statusBadgeClass = isCompleted ? 'status-completed' : 'status-pending';
        const statusText = isCompleted ? 'ƒê√£ ho√†n th√†nh' : 'Ch·ªù th·ª±c hi·ªán';
        
        // Generate assignment ID from data if not present
        const assignmentId = assignment.assignment_id || 
          `${assignment.reviewer_email}_${assignment.reviewee_email}_${assignment.target_type}`.replace(/[^a-zA-Z0-9_]/g, '_');
        
        // Map target_type to display name
        const targetTypeDisplay = assignment.target_type === 'EMPLOYEE' ? 'Nh√¢n vi√™n' : 'Qu·∫£n l√Ω';
        
        const revieweeInfo = assignment.reviewee ? `
          <div class="reviewee-info">
            <div class="info-row">
              <span class="info-label">Email:</span>
              <span class="info-value">${assignment.reviewee.email}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Ph√≤ng ban:</span>
              <span class="info-value">${assignment.reviewee.department || 'N/A'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Ch·ª©c v·ª•:</span>
              <span class="info-value">${assignment.reviewee.position || 'N/A'}</span>
            </div>
          </div>
        ` : '<p style="color: #f44336;">‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n</p>';

        const actionButton = isCompleted ? `
          <button class="action-button btn-view" onclick="alert('T√≠nh nƒÉng xem k·∫øt qu·∫£ ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn')">
            üëÅÔ∏è Xem k·∫øt qu·∫£ ƒë√£ n·ªôp
          </button>
        ` : `
          <a href="evaluation.html?reviewee_email=${encodeURIComponent(assignment.reviewee_email)}&target_type=${assignment.target_type}" class="action-button btn-review">
            ‚≠ê B·∫Øt ƒë·∫ßu ƒë√°nh gi√°
          </a>
        `;

        return `
          <div class="assignment-card ${statusClass}">
            <div class="card-header">
              <h3 class="reviewee-name">
                ${assignment.reviewee ? assignment.reviewee.name : assignment.reviewee_email}
              </h3>
              <span class="status-badge ${statusBadgeClass}">${statusText}</span>
            </div>

            ${revieweeInfo}

            <div class="assignment-details">
              <h4>Chi ti·∫øt ph√¢n c√¥ng</h4>
              <div class="info-row">
                <span class="info-label">Lo·∫°i ƒë√°nh gi√°:</span>
                <span class="info-value">${targetTypeDisplay} (${assignment.target_type})</span>
              </div>
              <div class="info-row">
                <span class="info-label">K·ª≥ ƒë√°nh gi√°:</span>
                <span class="info-value">${assignment.period || '2025'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Tr·∫°ng th√°i:</span>
                <span class="info-value">${assignment.status}</span>
              </div>
            </div>

            ${actionButton}
          </div>
        `;
      }).join('');

      container.innerHTML = `<div class="assignments-grid">${assignmentsHTML}</div>`;
    }

    // C·∫≠p nh·∫≠t th·ªëng k√™
    function updateStats(assignments) {
      const total = assignments.length;
      const completed = assignments.filter(a => a.status === 'COMPLETED').length;
      const pending = total - completed;

      document.getElementById('total-assignments').textContent = total;
      document.getElementById('completed-assignments').textContent = completed;
      document.getElementById('pending-assignments').textContent = pending;
      
      document.getElementById('stats').style.display = 'grid';
    }

    // Kh·ªüi t·∫°o trang
    document.addEventListener('DOMContentLoaded', function() {
      loadAssignments();
    });
  </script>
</body>

</html>