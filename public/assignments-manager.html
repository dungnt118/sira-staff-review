<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Qu·∫£n l√Ω ƒê√°nh gi√° - Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .header h1 {
      color: #333;
      font-size: 24px;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #2196F3;
      color: white;
    }

    .btn-primary:hover {
      background: #1976D2;
    }

    .btn-success {
      background: #4CAF50;
      color: white;
    }

    .btn-success:hover {
      background: #45a049;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .main-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .filters {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .filter-group label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .stats {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: #f5f5f5;
      padding: 15px 20px;
      border-radius: 8px;
      border-left: 4px solid #2196F3;
    }

    .stat-card h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 5px;
    }

    .stat-card p {
      font-size: 12px;
      color: #666;
    }

    .stat-card-warning {
      border-left-color: #FF9800;
      background: #fff3e0;
    }

    .stat-card-info {
      border-left-color: #9C27B0;
      background: #f3e5f5;
    }

    .stat-card-success {
      border-left-color: #4CAF50;
      background: #e8f5e9;
    }

    .assignments-table-container {
      overflow-x: auto;
      margin-bottom: 20px;
    }

    .assignments-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .assignments-table th,
    .assignments-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .assignments-table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .assignments-table tbody tr:hover {
      background: #f9f9f9;
    }

    .assignments-table tbody tr.duplicate-row {
      background: #fff3e0 !important;
      border-left: 3px solid #ff9800;
    }

    .assignments-table tbody tr.duplicate-row:hover {
      background: #ffe0b2 !important;
    }

    .assignments-table tbody tr.manager-row {
      background: #e8f5e9 !important;
      border-left: 3px solid #4caf50;
    }

    .assignments-table tbody tr.manager-row:hover {
      background: #c8e6c9 !important;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .badge-employee {
      background: #e3f2fd;
      color: #1976d2;
    }

    .badge-manager {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .badge-pending {
      background: #fff3e0;
      color: #f57c00;
    }

    .badge-completed {
      background: #e8f5e9;
      color: #388e3c;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      overflow: auto;
    }

    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-header h2 {
      color: #333;
      font-size: 20px;
    }

    .close {
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #000;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: #2196F3;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #c62828;
    }

    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      border-left: 4px solid #2e7d32;
    }

    .info-text {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }

    .select-all-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .bulk-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .bulk-actions span {
      color: #666;
      font-size: 14px;
    }

    .selected-reviewees-list {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      max-height: 200px;
      overflow-y: auto;
    }

    .selected-reviewees-list h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }

    .selected-reviewee-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .selected-reviewee-info {
      flex: 1;
    }

    .selected-reviewee-name {
      font-weight: 500;
      color: #333;
    }

    .selected-reviewee-meta {
      color: #888;
      font-size: 12px;
      margin: 2px 0;
    }

    .selected-reviewee-email {
      color: #666;
      font-size: 12px;
    }

    .selected-reviewee-remove {
      background: #f44336;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
    }

    .selected-reviewee-remove:hover {
      background: #d32f2f;
    }

    .empty-reviewees {
      text-align: center;
      color: #999;
      padding: 20px;
      font-style: italic;
    }

    /* Searchable Select Styles */
    .searchable-select-wrapper {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .search-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 5px rgba(33, 150, 243, 0.2);
    }

    .searchable-select-wrapper select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      height: auto;
      min-height: 100px;
      background-color: white;
    }

    .searchable-select-wrapper select:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 5px rgba(33, 150, 243, 0.2);
    }

    .searchable-select-wrapper option {
      padding: 5px;
      line-height: 1.5;
    }

    .btn-info {
      background: #2196F3;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 13px;
      transition: background 0.3s;
    }

    .btn-info:hover {
      background: #1976D2;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Qu·∫£n l√Ω ƒê√°nh gi√°</h1>
      <div class="nav-buttons">
        <a href="dashboard.html" class="btn btn-primary">‚Üê Dashboard</a>
        <button onclick="logout()" class="btn btn-danger">ƒêƒÉng xu·∫•t</button>
      </div>
    </div>

    <div class="main-content">
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
      </div>

      <div id="content" style="display: none;">
        <!-- Stats -->
        <div class="stats">
          <div class="stat-card">
            <h3 id="totalAssignments">0</h3>
            <p>T·ªïng s·ªë ƒê√°nh gi√°</p>
          </div>
          <div class="stat-card">
            <h3 id="totalEmployees">0</h3>
            <p>Nh√¢n vi√™n</p>
          </div>
          <div class="stat-card">
            <h3 id="pendingCount">0</h3>
            <p>ƒêang ch·ªù</p>
          </div>
          <div class="stat-card">
            <h3 id="completedCount">0</h3>
            <p>ƒê√£ ho√†n th√†nh</p>
          </div>
          <div class="stat-card stat-card-warning">
            <h3 id="noReviewerCount">0</h3>
            <p>Ch∆∞a c√≥ Ng∆∞·ªùi ƒë√°nh gi√°</p>
          </div>
          <div class="stat-card stat-card-info">
            <h3 id="noRevieweeCount">0</h3>
            <p>Ch∆∞a c√≥ Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°</p>
          </div>
          <div class="stat-card stat-card-danger">
            <h3 id="duplicateCount">0</h3>
            <p>B·∫£n ghi tr√πng l·∫∑p</p>
          </div>
          <div class="stat-card stat-card-success">
            <h3 id="employeeCount">0</h3>
            <p>ƒê√°nh gi√° Nh√¢n vi√™n</p>
          </div>
          <div class="stat-card stat-card-warning">
            <h3 id="managerCount">0</h3>
            <p>ƒê√°nh gi√° Qu·∫£n l√Ω</p>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters">
          <div class="filter-group">
            <label>L·ªçc theo Ng∆∞·ªùi ƒë√°nh gi√°</label>
            <select id="filterReviewer" onchange="applyFilters()">
              <option value="">-- T·∫•t c·∫£ --</option>
            </select>
          </div>
          <div class="filter-group">
            <label>L·ªçc theo Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°</label>
            <select id="filterReviewee" onchange="applyFilters()">
              <option value="">-- T·∫•t c·∫£ --</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Lo·∫°i ƒë√°nh gi√°</label>
            <select id="filterType" onchange="applyFilters()">
              <option value="">-- T·∫•t c·∫£ --</option>
              <option value="EMPLOYEE">Nh√¢n vi√™n</option>
              <option value="MANAGER">Qu·∫£n l√Ω</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Tr·∫°ng th√°i</label>
            <select id="filterStatus" onchange="applyFilters()">
              <option value="">-- T·∫•t c·∫£ --</option>
              <option value="PENDING">ƒêang ch·ªù</option>
              <option value="COMPLETED">ƒê√£ ho√†n th√†nh</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Nh√≥m d·ªØ li·ªáu</label>
            <select id="groupByMode" onchange="applyFilters()">
              <option value="none">Kh√¥ng nh√≥m</option>
              <option value="reviewer">Nh√≥m theo Ng∆∞·ªùi ƒë√°nh gi√°</option>
              <option value="reviewee">Nh√≥m theo Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button onclick="resetFilters()" class="btn btn-primary">ƒê·∫∑t l·∫°i</button>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions" style="display: none;" id="bulkActions">
          <span id="selectedCount">0 ƒë√°nh gi√° ƒë√£ ch·ªçn</span>
          <button onclick="bulkDelete()" class="btn btn-danger btn-sm">X√≥a</button>
          <button onclick="bulkUpdateStatus('COMPLETED')" class="btn btn-success btn-sm">ƒê√°nh d·∫•u ho√†n th√†nh</button>
          <button onclick="bulkUpdateStatus('PENDING')" class="btn btn-primary btn-sm">ƒê√°nh d·∫•u ch·ªù</button>
        </div>

        <!-- Action Buttons -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <button onclick="openAddModal()" class="btn btn-success">‚ûï Th√™m ƒê√°nh gi√°</button>
          <button onclick="deleteDuplicates()" class="btn btn-danger">üóëÔ∏è Xo√° tr√πng</button>
          <button onclick="saveAllChanges()" class="btn btn-primary">üíæ L∆∞u t·∫•t c·∫£ thay ƒë·ªïi</button>
          <button onclick="loadData()" class="btn btn-primary">üîÑ T·∫£i l·∫°i</button>
          <button onclick="toggleDetailReport()" class="btn btn-info">üìä B√°o c√°o chi ti·∫øt</button>
        </div>

        <!-- Detailed Report -->
        <div id="detailReportSection" style="display: none; margin-bottom: 20px;">
          <div style="background: #f5f5f5; padding: 20px; border-radius: 8px;">
            <h3>üìã B√°o c√°o Chi ti·∫øt</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
              <div>
                <h4>üë§ Nh√¢n vi√™n ch∆∞a c√≥ Ng∆∞·ªùi ƒë√°nh gi√° (ch∆∞a ai ƒë√°nh gi√°)</h4>
                <div id="noReviewerList" style="background: white; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;"></div>
              </div>
              <div>
                <h4>üë• Nh√¢n vi√™n ch∆∞a ƒë∆∞·ª£c giao ƒë√°nh gi√° ai</h4>
                <div id="noRevieweeList" style="background: white; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="assignments-table-container">
          <table class="assignments-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="selectAll" class="checkbox" onchange="toggleSelectAll()">
                </th>
                <th style="width: 180px;">Ng∆∞·ªùi ƒë√°nh gi√°</th>
                <th style="width: 100px;">Ph√≤ng ban</th>
                <th style="width: 180px;">Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°</th>
                <th style="width: 100px;">Ph√≤ng ban</th>
                <th style="width: 100px;">Lo·∫°i ƒêG</th>
                <th style="width: 100px;">Tr·∫°ng th√°i</th>
                <th style="width: 150px;">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="assignmentsTableBody">
              <!-- Data will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div id="assignmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle">Th√™m ƒê√°nh gi√°</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      
      <div id="modalError" class="error-message" style="display: none;"></div>
      
      <!-- Mode Toggle (only for add modal, not edit) -->
      <div id="modeToggleSection" style="display: none; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; align-items: center;">
          <span style="font-weight: 600; color: #333;">Ch·∫ø ƒë·ªô:</span>
          <button type="button" id="modeToggleBtn" class="btn btn-toggle" onclick="toggleMode()" style="background: #2196F3; color: white; padding: 8px 16px; border-radius: 20px;">
            Ch·∫ø ƒë·ªô 2: Theo Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°
          </button>
        </div>
        <p style="font-size: 12px; color: #666; margin: 8px 0 0 0;">
          <strong id="modeDesc">Ch·∫ø ƒë·ªô 2:</strong> <span id="modeDescText">Ch·ªçn 1 ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°, sau ƒë√≥ ch·ªçn nhi·ªÅu ng∆∞·ªùi ƒë√°nh gi√°</span>
        </p>
      </div>
      
      <form id="assignmentForm" onsubmit="saveAssignment(event)">
        <div id="singleMode" style="display: none;">
          <!-- Single mode: edit existing -->
          <div class="form-group">
            <label>Ng∆∞·ªùi ƒë√°nh gi√° *</label>
            <select id="reviewerSelectSingle" required>
              <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë√°nh gi√° --</option>
            </select>
            <div class="info-text" id="reviewerInfoSingle"></div>
          </div>

          <div class="form-group">
            <label>Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° *</label>
            <select id="revieweeSelectSingle" required>
              <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° --</option>
            </select>
            <div class="info-text" id="revieweeInfoSingle"></div>
          </div>

          <div class="form-group">
            <label>Lo·∫°i ƒë√°nh gi√° *</label>
            <select id="targetTypeSelectSingle" required>
              <option value="">-- Ch·ªçn lo·∫°i --</option>
              <option value="EMPLOYEE">Nh√¢n vi√™n (EMPLOYEE)</option>
              <option value="MANAGER">Qu·∫£n l√Ω (MANAGER)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Tr·∫°ng th√°i</label>
            <select id="statusSelectSingle">
              <option value="PENDING">ƒêang ch·ªù (PENDING)</option>
              <option value="COMPLETED">ƒê√£ ho√†n th√†nh (COMPLETED)</option>
            </select>
          </div>
        </div>

        <div id="bulkMode">
          <!-- Bulk mode: add multiple reviewees -->
          <div class="form-group">
            <label>Ng∆∞·ªùi ƒë√°nh gi√° *</label>
            <select id="reviewerSelectBulk" required onchange="onBulkReviewerChange()">
              <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë√°nh gi√° --</option>
            </select>
            <div class="info-text" id="reviewerInfoBulk"></div>
          </div>

          <div class="form-group">
            <label>Lo·∫°i ƒë√°nh gi√° *</label>
            <select id="targetTypeSelectBulk" required onchange="onBulkTargetTypeChange()">
              <option value="">-- Ch·ªçn lo·∫°i --</option>
              <option value="EMPLOYEE">Nh√¢n vi√™n (EMPLOYEE)</option>
              <option value="MANAGER">Qu·∫£n l√Ω (MANAGER)</option>
            </select>
          </div>

          <div class="form-group">
            <label>L·ªçc theo Ph√≤ng ban</label>
            <select id="departmentFilterBulk" onchange="onBulkDepartmentChange()">
              <option value="">-- T·∫•t c·∫£ ph√≤ng --</option>
            </select>
          </div>

          <div class="form-group">
            <label>Ch·ªçn Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° *</label>
            <div class="searchable-select-wrapper">
              <input type="text" id="revieweeSearchBulk" placeholder="üîç T√¨m ki·∫øm ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°..." class="search-input" onkeyup="filterRevieweeDropdown()">
              <select id="revieweeSelectBulk" onchange="onBulkRevieweeSelect()" size="5">
                <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° ƒë·ªÉ th√™m --</option>
              </select>
            </div>
            <div style="margin-top: 8px;">
              <button type="button" class="btn btn-sm btn-info" onclick="selectAllAvailableReviewees()">Ch·ªçn h·∫øt</button>
            </div>
          </div>

          <!-- Selected reviewees list -->
          <div class="selected-reviewees-list" id="selectedRevieweesList" style="display: none;">
            <h4 id="selectedRevieweesCount">0 Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° ƒë√£ ch·ªçn</h4>
            <div id="selectedRevieweesContainer"></div>
          </div>
        </div>

        <!-- Mode 2: Reviewee Centric Mode -->
        <div id="bulkMode2" style="display: none;">
          <!-- Bulk mode 2: select reviewee, then add multiple reviewers -->
          <div class="form-group">
            <label>Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° *</label>
            <select id="revieweeSelectMode2" required onchange="onMode2RevieweeChange()">
              <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° --</option>
            </select>
            <div class="info-text" id="revieweeInfoMode2"></div>
          </div>

          <div class="form-group">
            <label>Lo·∫°i ƒë√°nh gi√° *</label>
            <select id="targetTypeSelectMode2" required onchange="onMode2TargetTypeChange()">
              <option value="">-- Ch·ªçn lo·∫°i --</option>
              <option value="EMPLOYEE">Nh√¢n vi√™n (EMPLOYEE)</option>
              <option value="MANAGER">Qu·∫£n l√Ω (MANAGER)</option>
            </select>
          </div>

          <div class="form-group">
            <label>L·ªçc theo Ph√≤ng ban (Ng∆∞·ªùi ƒë√°nh gi√°)</label>
            <select id="departmentFilterMode2" onchange="onMode2DepartmentChange()">
              <option value="">-- T·∫•t c·∫£ ph√≤ng --</option>
            </select>
          </div>

          <div class="form-group">
            <label>Ch·ªçn Ng∆∞·ªùi ƒë√°nh gi√° *</label>
            <div class="searchable-select-wrapper">
              <input type="text" id="reviewerSearchMode2" placeholder="üîç T√¨m ki·∫øm ng∆∞·ªùi ƒë√°nh gi√°..." class="search-input" onkeyup="filterReviewerDropdownMode2()">
              <select id="reviewerSelectMode2" onchange="onMode2ReviewerSelect()" size="5">
                <option value="">-- Ch·ªçn ng∆∞·ªùi ƒë√°nh gi√° ƒë·ªÉ th√™m --</option>
              </select>
            </div>
            <div style="margin-top: 8px;">
              <button type="button" class="btn btn-sm btn-info" onclick="selectAllAvailableReviewersMode2()">Ch·ªçn h·∫øt</button>
            </div>
          </div>

          <!-- Selected reviewers list for Mode 2 -->
          <div class="selected-reviewees-list" id="selectedReviewersList" style="display: none;">
            <h4 id="selectedReviewersCount">0 Ng∆∞·ªùi ƒë√°nh gi√° ƒë√£ ch·ªçn</h4>
            <div id="selectedReviewersContainer"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" onclick="closeModal()" class="btn btn-danger">H·ªßy</button>
          <button type="submit" class="btn btn-success" id="submitBtn">L∆∞u</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Load config first -->
  <script src="js/config.js"></script>
  
  <!-- Auto cache busting -->
  <script>
    (function() {
      const CURRENT_VERSION = window.SIRA_CONFIG.VERSION;
      const storedVersion = localStorage.getItem('app_version');
      
      if (storedVersion && storedVersion !== CURRENT_VERSION) {
        console.log('üîÑ Ph√°t hi·ªán phi√™n b·∫£n m·ªõi (' + CURRENT_VERSION + '), ƒëang l√†m m·ªõi cache...');
        localStorage.setItem('app_version', CURRENT_VERSION);
        location.reload(true);
      } else {
        localStorage.setItem('app_version', CURRENT_VERSION);
      }
    })();
  </script>

  <script>
    let allAssignments = [];
    let allEmployees = [];
    let filteredAssignments = [];
    let editingIndex = -1;
    let selectedAssignments = new Set();
    
    // For bulk add mode (Mode 1: Reviewer Centric)
    let bulkSelectedReviewer = '';
    let bulkSelectedTargetType = '';
    let bulkSelectedReviewees = new Set();

    // For bulk mode 2 (Mode 2: Reviewee Centric)
    let currentMode = 2; // Default: Mode 2 (1 = Mode 1: Reviewer Centric, 2 = Mode 2: Reviewee Centric)
    let bulkSelectedReviewee = '';
    let bulkSelectedTargetTypeMode2 = '';
    let bulkSelectedReviewers = new Set();

    // Load data on page load
    window.addEventListener('DOMContentLoaded', async () => {
      // Wait for SIRA_API to be available
      if (!window.SIRA_API) {
        console.error('SIRA_API not loaded!');
        alert('L·ªói: Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh h·ªá th·ªëng');
        return;
      }

      const user = JSON.parse(localStorage.getItem('currentUser'));
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      // Check if user is admin - role c√≥ th·ªÉ ·ªü user.employee.role ho·∫∑c user.auth.role
      const userRole = user?.employee?.role || user?.auth?.role || user?.role || 'USER';
      if (userRole !== 'ADMIN') {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
        window.location.href = 'dashboard.html';
        return;
      }

      await loadData();
    });

    async function loadData() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';

        // Debug: Check if SIRA_API methods exist
        console.log('SIRA_API:', window.SIRA_API);
        console.log('getAllEmployees exists:', typeof window.SIRA_API?.getAllEmployees);
        console.log('getAllAssignments exists:', typeof window.SIRA_API?.getAllAssignments);

        // Load employees and assignments in parallel using SIRA_API
        const [employeesData, assignmentsData] = await Promise.all([
          window.SIRA_API.getAllEmployees(),
          window.SIRA_API.getAllAssignments()
        ]);

        if (!employeesData.success || !assignmentsData.success) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
        }

        allEmployees = employeesData.employees || [];
        allAssignments = assignmentsData.assignments || [];
        
        console.log('%c‚úÖ Loaded data', 'color: green; font-weight: bold;', {
          employees: allEmployees.length,
          assignments: allAssignments.length
        });

        // Debug: Show first few assignments structure
        if (allAssignments.length > 0) {
          console.log('%cüìã Sample assignments:', 'color: orange;', allAssignments.slice(0, 3));
        }

        updateStats();
        populateFilters();
        populateSelects();
        applyFilters();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      } catch (error) {
        console.error('Error loading data:', error);
        alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + error.message);
      }
    }

    function updateStats() {
      document.getElementById('totalAssignments').textContent = allAssignments.length;
      document.getElementById('totalEmployees').textContent = allEmployees.length;
      
      const pending = allAssignments.filter(a => a.status === 'PENDING').length;
      const completed = allAssignments.filter(a => a.status === 'COMPLETED').length;
      
      document.getElementById('pendingCount').textContent = pending;
      document.getElementById('completedCount').textContent = completed;

      // T√≠nh s·ªë nh√¢n vi√™n ch∆∞a c√≥ reviewer (ch∆∞a ai review h·ªç)
      const revieweeEmails = new Set(allAssignments.map(a => a.reviewee_email));
      const noReviewerCount = allEmployees.filter(emp => !revieweeEmails.has(emp.email)).length;
      document.getElementById('noReviewerCount').textContent = noReviewerCount;

      // T√≠nh s·ªë nh√¢n vi√™n ch∆∞a c√≥ reviewee (ch∆∞a review ai)
      const reviewerEmails = new Set(allAssignments.map(a => a.reviewer_email));
      const noRevieweeCount = allEmployees.filter(emp => !reviewerEmails.has(emp.email)).length;
      document.getElementById('noRevieweeCount').textContent = noRevieweeCount;

      // T√≠nh s·ªë b·∫£n ghi tr√πng l·∫∑p (t·ª´ b·∫£n ghi th·ª© 2 tr·ªü ƒëi)
      const seen = new Map();
      let duplicateCount = 0;
      allAssignments.forEach((assignment) => {
        const key = `${assignment.reviewer_email}|${assignment.reviewee_email}|${assignment.target_type}`;
        if (seen.has(key)) {
          duplicateCount++;
        } else {
          seen.set(key, true);
        }
      });
      document.getElementById('duplicateCount').textContent = duplicateCount;

      // T√≠nh s·ªë assignment theo lo·∫°i
      const employeeCount = allAssignments.filter(a => a.target_type === 'EMPLOYEE').length;
      const managerCount = allAssignments.filter(a => a.target_type === 'MANAGER').length;
      document.getElementById('employeeCount').textContent = employeeCount;
      document.getElementById('managerCount').textContent = managerCount;
    }

    function populateFilters() {
      const reviewerSet = new Set();
      const revieweeSet = new Set();

      allAssignments.forEach(a => {
        reviewerSet.add(a.reviewer_email);
        revieweeSet.add(a.reviewee_email);
      });

      const reviewerSelect = document.getElementById('filterReviewer');
      const revieweeSelect = document.getElementById('filterReviewee');

      reviewerSelect.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';
      revieweeSelect.innerHTML = '<option value="">-- T·∫•t c·∫£ --</option>';

      Array.from(reviewerSet).sort().forEach(email => {
        const emp = allEmployees.find(e => e.email === email);
        const name = emp ? emp.name : email;
        reviewerSelect.innerHTML += `<option value="${email}">${name} (${email})</option>`;
      });

      Array.from(revieweeSet).sort().forEach(email => {
        const emp = allEmployees.find(e => e.email === email);
        const name = emp ? emp.name : email;
        revieweeSelect.innerHTML += `<option value="${email}">${name} (${email})</option>`;
      });
    }

    function populateSelects() {
      // Populate single mode selects (for edit)
      const reviewerSelectSingle = document.getElementById('reviewerSelectSingle');
      const revieweeSelectSingle = document.getElementById('revieweeSelectSingle');
      
      // Populate bulk mode selects
      const reviewerSelectBulk = document.getElementById('reviewerSelectBulk');
      const revieweeSelectBulk = document.getElementById('revieweeSelectBulk');

      // Populate mode 2 selects
      const revieweeSelectMode2 = document.getElementById('revieweeSelectMode2');

      [reviewerSelectSingle, reviewerSelectBulk].forEach(select => {
        select.innerHTML = '<option value="">-- Ch·ªçn reviewer --</option>';
        allEmployees.forEach(emp => {
          const option = `<option value="${emp.email}">${emp.name} - ${emp.department} (${emp.email})</option>`;
          select.innerHTML += option;
        });
      });

      [revieweeSelectSingle, revieweeSelectBulk].forEach(select => {
        select.innerHTML = '<option value="">-- Ch·ªçn reviewee --</option>';
        allEmployees.forEach(emp => {
          const option = `<option value="${emp.email}">${emp.name} - ${emp.department} (${emp.email})</option>`;
          select.innerHTML += option;
        });
      });

      // Populate mode 2 reviewee select
      revieweeSelectMode2.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° --</option>';
      allEmployees.forEach(emp => {
        const option = `<option value="${emp.email}">${emp.name} - ${emp.department} (${emp.email})</option>`;
        revieweeSelectMode2.innerHTML += option;
      });

      // Add event listeners for single mode
      reviewerSelectSingle.addEventListener('change', (e) => {
        const emp = allEmployees.find(emp => emp.email === e.target.value);
        document.getElementById('reviewerInfoSingle').textContent = emp ? 
          `Ph√≤ng ban: ${emp.department} | Ch·ª©c v·ª•: ${emp.position}` : '';
      });

      revieweeSelectSingle.addEventListener('change', (e) => {
        const emp = allEmployees.find(emp => emp.email === e.target.value);
        document.getElementById('revieweeInfoSingle').textContent = emp ? 
          `Ph√≤ng ban: ${emp.department} | Ch·ª©c v·ª•: ${emp.position}` : '';
      });

      // Add event listeners for bulk mode
      reviewerSelectBulk.addEventListener('change', onBulkReviewerChange);
    }

    // Bulk mode: when reviewer changes
    function onBulkReviewerChange() {
      const reviewer = document.getElementById('reviewerSelectBulk').value;
      console.log('Reviewer changed:', reviewer);
      if (!reviewer) return;
      
      bulkSelectedReviewer = reviewer;
      const emp = allEmployees.find(e => e.email === reviewer);
      document.getElementById('reviewerInfoBulk').textContent = emp ? 
        `Ph√≤ng ban: ${emp.department} | Ch·ª©c v·ª•: ${emp.position}` : '';
      
      // Reset department filter when reviewer changes
      document.getElementById('departmentFilterBulk').value = '';
      
      // Update reviewee dropdown when target type is also selected
      onBulkTargetTypeChange();
    }

    // Bulk mode: when target type changes
    function onBulkTargetTypeChange() {
      const targetType = document.getElementById('targetTypeSelectBulk').value;
      console.log('Target type changed:', targetType);
      bulkSelectedTargetType = targetType;
      
      // Populate department filter
      populateDepartmentFilterBulk();
      
      filterAndUpdateBulkRevieweeSelect();
    }

    // Populate department filter dropdown
    function populateDepartmentFilterBulk() {
      const departmentFilter = document.getElementById('departmentFilterBulk');
      const currentValue = departmentFilter.value;
      
      // Get unique departments
      const departments = new Set();
      allEmployees.forEach(emp => {
        if (emp.department) {
          departments.add(emp.department);
        }
      });

      departmentFilter.innerHTML = '<option value="">-- T·∫•t c·∫£ ph√≤ng --</option>';
      Array.from(departments).sort().forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentFilter.appendChild(option);
      });

      departmentFilter.value = currentValue;
    }

    // Populate department filter for Mode 2 (filter reviewers by department)
    function populateDepartmentFilterMode2() {
      const departmentFilter = document.getElementById('departmentFilterMode2');
      const currentValue = departmentFilter.value;
      
      // Get unique departments
      const departments = new Set();
      allEmployees.forEach(emp => {
        if (emp.department) {
          departments.add(emp.department);
        }
      });

      departmentFilter.innerHTML = '<option value="">-- T·∫•t c·∫£ ph√≤ng --</option>';
      Array.from(departments).sort().forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentFilter.appendChild(option);
      });

      departmentFilter.value = currentValue;
    }

    // Bulk mode: when department filter changes
    function onBulkDepartmentChange() {
      console.log('Department filter changed');
      filterAndUpdateBulkRevieweeSelect();
    }

    // Filter reviewee dropdown for bulk mode
    function filterAndUpdateBulkRevieweeSelect() {
      const reviewer = document.getElementById('reviewerSelectBulk').value;
      const targetType = document.getElementById('targetTypeSelectBulk').value;
      const departmentFilter = document.getElementById('departmentFilterBulk').value;
      const revieweeSelectBulk = document.getElementById('revieweeSelectBulk');

      revieweeSelectBulk.innerHTML = '<option value="">-- Ch·ªçn reviewee ƒë·ªÉ th√™m --</option>';

      // N·∫øu ch∆∞a ch·ªçn reviewer ho·∫∑c target type, kh√¥ng show reviewee list
      if (!reviewer || !targetType) {
        console.log('‚ö†Ô∏è  Skip filter: reviewer=' + reviewer + ', targetType=' + targetType);
        return;
      }

      const normReviewer = (reviewer || '').toLowerCase().trim();
      const normTargetType = (targetType || '').toUpperCase().trim();

      console.log('%cüìã Filtering reviewees', 'color: blue; font-weight: bold;', {
        reviewer: normReviewer,
        targetType: normTargetType,
        department: departmentFilter,
        allAssignmentsCount: allAssignments.length,
        allEmployeesCount: allEmployees.length,
        bulkSelectedCount: bulkSelectedReviewees.size
      });

      const availableReviewees = allEmployees.filter(emp => {
        const empEmail = (emp.email || '').toLowerCase().trim();

        // Filter by department if selected
        if (departmentFilter && emp.department !== departmentFilter) {
          return false;
        }

        // Exclude self
        if (empEmail === normReviewer) {
          console.log(`  ‚ùå ${emp.name} - b·ªè v√¨ l√† reviewer`);
          return false;
        }
        
        // Exclude already selected in bulk
        if (bulkSelectedReviewees.has(emp.email)) {
          console.log(`  ‚ùå ${emp.name} - b·ªè v√¨ ƒë√£ ƒë∆∞·ª£c ch·ªçn`);
          return false;
        }
        
        // Exclude if already has assignment with this reviewer + target type
        const hasDuplicate = allAssignments.some(a => {
          const aReviewer = (a.reviewer_email || '').toLowerCase().trim();
          const aReviewee = (a.reviewee_email || '').toLowerCase().trim();
          const aType = (a.target_type || '').toUpperCase().trim();

          const match = aReviewer === normReviewer &&
                        aReviewee === empEmail &&
                        aType === normTargetType;

          if (match) {
            console.log(`  ‚ùå ${emp.name} - b·ªè v√¨: assignment(${aReviewer}->${aReviewee}, ${aType})`);
          }
          return match;
        });
        
        if (hasDuplicate) return false;
        
        console.log(`  ‚úÖ ${emp.name} - gi·ªØ l·∫°i`);
        return true;
      });

      console.log(`üìä Result: ${availableReviewees.length} available (t·ª´ ${allEmployees.length} t·ªïng)`);

      availableReviewees.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.email;
        option.textContent = `${emp.name} - ${emp.department}`;
        revieweeSelectBulk.appendChild(option);
      });
    }

    // Bulk mode: add reviewee to list
    function onBulkRevieweeSelect() {
      const email = document.getElementById('revieweeSelectBulk').value;
      if (!email) return;
      
      bulkSelectedReviewees.add(email);
      document.getElementById('revieweeSelectBulk').value = '';
      
      renderBulkSelectedReviewees();
      filterAndUpdateBulkRevieweeSelect();
    }

    // Bulk mode: remove reviewee from list
    function removeBulkReviewee(email) {
      bulkSelectedReviewees.delete(email);
      renderBulkSelectedReviewees();
      filterAndUpdateBulkRevieweeSelect();
    }

    // Bulk mode: render selected reviewees list
    function renderBulkSelectedReviewees() {
      const list = document.getElementById('selectedRevieweesList');
      const count = document.getElementById('selectedRevieweesCount');
      const container = document.getElementById('selectedRevieweesContainer');

      const selectedCount = bulkSelectedReviewees.size;
      count.textContent = `${selectedCount} Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° ƒë√£ ch·ªçn`;

      if (selectedCount === 0) {
        list.style.display = 'none';
        return;
      }

      list.style.display = 'block';
      container.innerHTML = Array.from(bulkSelectedReviewees).map(email => {
        const emp = allEmployees.find(e => e.email === email);
        return `
          <div class="selected-reviewee-item">
            <div class="selected-reviewee-info">
              <div class="selected-reviewee-name">${emp?.name || email}</div>
              <div class="selected-reviewee-meta">${emp?.department || ''} | ${emp?.position || ''}</div>
              <div class="selected-reviewee-email">${email}</div>
            </div>
            <button type="button" class="selected-reviewee-remove" onclick="removeBulkReviewee('${email}')">‚úï</button>
          </div>
        `;
      }).join('');
    }

    // Filter reviewee dropdown by search text
    function filterRevieweeDropdown() {
      const searchInput = document.getElementById('revieweeSearchBulk');
      const selectElement = document.getElementById('revieweeSelectBulk');
      const searchText = (searchInput?.value || '').toLowerCase();
      const options = selectElement.querySelectorAll('option');

      options.forEach(option => {
        if (option.value === '') {
          option.style.display = 'block'; // Always show placeholder
          return;
        }
        const emp = allEmployees.find(e => e.email === option.value);
        const matchText = `${emp?.name || ''} ${emp?.department || ''} ${emp?.email || ''}`.toLowerCase();
        option.style.display = matchText.includes(searchText) ? 'block' : 'none';
      });
    }

    // Select all available reviewees
    function selectAllAvailableReviewees() {
      const selectElement = document.getElementById('revieweeSelectBulk');
      const options = selectElement.querySelectorAll('option');

      options.forEach(option => {
        if (option.value && option.style.display !== 'none') {
          bulkSelectedReviewees.add(option.value);
        }
      });

      document.getElementById('revieweeSearchBulk').value = '';
      filterRevieweeDropdown();
      selectElement.value = '';
      renderBulkSelectedReviewees();
      filterAndUpdateBulkRevieweeSelect();
    }

    // ============ MODE 2 FUNCTIONS (Reviewee Centric) ============

    // Mode 2: When reviewer selection changes
    function onMode2RevieweeChange() {
      const email = document.getElementById('revieweeSelectMode2').value;
      const name = email ? allEmployees.find(e => e.email === email)?.name || email : '';
      const department = email ? allEmployees.find(e => e.email === email)?.department || '' : '';
      
      if (email) {
        document.getElementById('revieweeInfoMode2').textContent = `${name} | ${department}`;
      } else {
        document.getElementById('revieweeInfoMode2').textContent = '';
      }
      
      bulkSelectedReviewee = email;
      filterAndUpdateMode2ReviewerSelect();
    }

    // Mode 2: When target type changes
    function onMode2TargetTypeChange() {
      bulkSelectedTargetTypeMode2 = document.getElementById('targetTypeSelectMode2').value;
      filterAndUpdateMode2ReviewerSelect();
    }

    // Mode 2: When department filter changes
    function onMode2DepartmentChange() {
      filterAndUpdateMode2ReviewerSelect();
    }

    // Mode 2: When reviewer is selected from dropdown
    function onMode2ReviewerSelect() {
      const email = document.getElementById('reviewerSelectMode2').value;
      if (!email) return;
      
      bulkSelectedReviewers.add(email);
      document.getElementById('reviewerSelectMode2').value = '';
      document.getElementById('reviewerSearchMode2').value = '';
      filterReviewerDropdownMode2();
      renderMode2SelectedReviewers();
      filterAndUpdateMode2ReviewerSelect();
    }

    // Mode 2: Filter reviewer dropdown
    function filterReviewerDropdownMode2() {
      const searchText = document.getElementById('reviewerSearchMode2').value.toLowerCase();
      const options = document.getElementById('reviewerSelectMode2').querySelectorAll('option');

      options.forEach(option => {
        if (option.value === '') {
          option.style.display = 'block'; // Always show placeholder
          return;
        }
        const emp = allEmployees.find(e => e.email === option.value);
        const matchText = `${emp?.name || ''} ${emp?.department || ''} ${emp?.email || ''}`.toLowerCase();
        option.style.display = matchText.includes(searchText) ? 'block' : 'none';
      });
    }

    // Mode 2: Select all available reviewers
    function selectAllAvailableReviewersMode2() {
      const selectElement = document.getElementById('reviewerSelectMode2');
      const options = selectElement.querySelectorAll('option');

      options.forEach(option => {
        if (option.value && option.style.display !== 'none') {
          bulkSelectedReviewers.add(option.value);
        }
      });

      document.getElementById('reviewerSearchMode2').value = '';
      filterReviewerDropdownMode2();
      selectElement.value = '';
      renderMode2SelectedReviewers();
      filterAndUpdateMode2ReviewerSelect();
    }

    // Mode 2: Render selected reviewers list
    function renderMode2SelectedReviewers() {
      const container = document.getElementById('selectedReviewersContainer');
      const listDiv = document.getElementById('selectedReviewersList');
      const countElement = document.getElementById('selectedReviewersCount');

      if (bulkSelectedReviewers.size === 0) {
        listDiv.style.display = 'none';
        return;
      }

      container.innerHTML = '';
      bulkSelectedReviewers.forEach(email => {
        const emp = allEmployees.find(e => e.email === email);
        const item = document.createElement('div');
        item.className = 'selected-reviewee-item';
        item.innerHTML = `
          <div class="selected-reviewee-info">
            <div class="selected-reviewee-name">${emp?.name || email}</div>
            <div class="selected-reviewee-meta">${emp?.department || ''} | ${emp?.position || ''}</div>
            <div class="selected-reviewee-email">${email}</div>
          </div>
          <button type="button" class="selected-reviewee-remove" onclick="removeMode2SelectedReviewer('${email}')">‚úï</button>
        `;
        container.appendChild(item);
      });

      countElement.textContent = `${bulkSelectedReviewers.size} Ng∆∞·ªùi ƒë√°nh gi√° ƒë√£ ch·ªçn`;
      listDiv.style.display = 'block';
    }

    // Mode 2: Remove selected reviewer from list
    function removeMode2SelectedReviewer(email) {
      bulkSelectedReviewers.delete(email);
      renderMode2SelectedReviewers();
      filterAndUpdateMode2ReviewerSelect();
    }

    // Mode 2: Filter and update reviewer dropdown
    function filterAndUpdateMode2ReviewerSelect() {
      const revieweeEmail = document.getElementById('revieweeSelectMode2').value;
      const targetType = document.getElementById('targetTypeSelectMode2').value;
      const departmentFilter = document.getElementById('departmentFilterMode2').value;
      const reviewerSelectMode2 = document.getElementById('reviewerSelectMode2');

      reviewerSelectMode2.innerHTML = '<option value="">-- Ch·ªçn ng∆∞·ªùi ƒë√°nh gi√° ƒë·ªÉ th√™m --</option>';

      // N·∫øu ch∆∞a ch·ªçn reviewee ho·∫∑c target type, kh√¥ng show reviewer list
      if (!revieweeEmail || !targetType) {
        return;
      }

      const normReviewee = (revieweeEmail || '').toLowerCase().trim();
      const normTargetType = (targetType || '').toUpperCase().trim();

      const availableReviewers = allEmployees.filter(emp => {
        const empEmail = (emp.email || '').toLowerCase().trim();

        // Filter by department if selected
        if (departmentFilter && emp.department !== departmentFilter) {
          return false;
        }

        // Exclude self (reviewer cannot review themselves)
        if (empEmail === normReviewee) {
          return false;
        }
        
        // Exclude already selected reviewers
        if (bulkSelectedReviewers.has(emp.email)) {
          return false;
        }
        
        // Exclude if already has assignment with this reviewee + target type
        const hasDuplicate = allAssignments.some(a => {
          const aReviewer = (a.reviewer_email || '').toLowerCase().trim();
          const aReviewee = (a.reviewee_email || '').toLowerCase().trim();
          const aType = (a.target_type || '').toUpperCase().trim();

          return aReviewer === empEmail &&
                 aReviewee === normReviewee &&
                 aType === normTargetType;
        });
        
        if (hasDuplicate) return false;
        
        return true;
      });

      availableReviewers.forEach(emp => {
        const option = document.createElement('option');
        option.value = emp.email;
        option.textContent = `${emp.name} - ${emp.department}`;
        reviewerSelectMode2.appendChild(option);
      });
    }

    // ============ END MODE 2 FUNCTIONS ============

    function applyFilters() {
      const reviewerFilter = document.getElementById('filterReviewer').value;
      const revieweeFilter = document.getElementById('filterReviewee').value;
      const typeFilter = document.getElementById('filterType').value;
      const statusFilter = document.getElementById('filterStatus').value;

      filteredAssignments = allAssignments.filter(a => {
        if (reviewerFilter && a.reviewer_email !== reviewerFilter) return false;
        if (revieweeFilter && a.reviewee_email !== revieweeFilter) return false;
        if (typeFilter && a.target_type !== typeFilter) return false;
        if (statusFilter && a.status !== statusFilter) return false;
        return true;
      });

      renderTable();
    }

    function resetFilters() {
      document.getElementById('filterReviewer').value = '';
      document.getElementById('filterReviewee').value = '';
      document.getElementById('filterType').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('groupByMode').value = 'none';
      applyFilters();
    }

    // Toggle detail report section
    function toggleDetailReport() {
      const section = document.getElementById('detailReportSection');
      section.style.display = section.style.display === 'none' ? 'block' : 'none';
      if (section.style.display === 'block') {
        renderDetailReport();
      }
    }

    // Render detail report with lists of employees
    function renderDetailReport() {
      const reviewerEmails = new Set(allAssignments.map(a => a.reviewer_email));
      const revieweeEmails = new Set(allAssignments.map(a => a.reviewee_email));

      // Employees without reviewer
      const noReviewerEmps = allEmployees.filter(emp => !revieweeEmails.has(emp.email));
      const noReviewerHtml = noReviewerEmps.length === 0 
        ? '<p style="color: #999;">T·∫•t c·∫£ nh√¢n vi√™n ƒë·ªÅu c√≥ ng∆∞·ªùi ƒë√°nh gi√°</p>'
        : noReviewerEmps.map(emp => `
          <div style="padding: 8px; border-bottom: 1px solid #eee;">
            <strong>${emp.name}</strong> <br>
            <small>${emp.email} | ${emp.department}</small>
          </div>
        `).join('');

      // Employees without reviewee
      const noRevieweeEmps = allEmployees.filter(emp => !reviewerEmails.has(emp.email));
      const noRevieweeHtml = noRevieweeEmps.length === 0 
        ? '<p style="color: #999;">T·∫•t c·∫£ nh√¢n vi√™n ƒë·ªÅu ƒë∆∞·ª£c giao ƒë√°nh gi√°</p>'
        : noRevieweeEmps.map(emp => `
          <div style="padding: 8px; border-bottom: 1px solid #eee;">
            <strong>${emp.name}</strong> <br>
            <small>${emp.email} | ${emp.department}</small>
          </div>
        `).join('');

      document.getElementById('noReviewerList').innerHTML = noReviewerHtml;
      document.getElementById('noRevieweeList').innerHTML = noRevieweeHtml;
    }

    function renderTable() {
      const tbody = document.getElementById('assignmentsTableBody');
      tbody.innerHTML = '';

      if (filteredAssignments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #999;">Kh√¥ng c√≥ ƒë√°nh gi√° n√†o</td></tr>';
        return;
      }

      const groupMode = document.getElementById('groupByMode').value || 'none';

      if (groupMode === 'none') {
        // Render kh√¥ng nh√≥m
        renderTableNormal(tbody);
      } else if (groupMode === 'reviewer') {
        // Render nh√≥m theo reviewer
        renderTableGroupedByReviewer(tbody);
      } else if (groupMode === 'reviewee') {
        // Render nh√≥m theo reviewee
        renderTableGroupedByReviewee(tbody);
      }

      updateBulkActions();
    }

    // Detect duplicate assignments (same reviewer + reviewee + target_type)
    // Only mark duplicates from 2nd occurrence onwards, keep first record unmarked
    function detectDuplicates() {
      const duplicateIndices = new Set();
      const seen = new Map();

      filteredAssignments.forEach((assignment, index) => {
        const key = `${assignment.reviewer_email}|${assignment.reviewee_email}|${assignment.target_type}`;
        
        if (seen.has(key)) {
          // Only mark current record (duplicate), not the first occurrence
          duplicateIndices.add(index);
        } else {
          seen.set(key, index);
        }
      });

      return duplicateIndices;
    }

    // Render table b√¨nh th∆∞·ªùng (kh√¥ng nh√≥m)
    function renderTableNormal(tbody) {
      const duplicateIndices = detectDuplicates();
      
      filteredAssignments.forEach((assignment, index) => {
        const reviewer = allEmployees.find(e => e.email === assignment.reviewer_email);
        const reviewee = allEmployees.find(e => e.email === assignment.reviewee_email);
        const isDuplicate = duplicateIndices.has(index);
        const isManager = assignment.target_type === 'MANAGER';

        const row = document.createElement('tr');
        if (isDuplicate) {
          row.classList.add('duplicate-row');
        }
        if (isManager) {
          row.classList.add('manager-row');
        }
        row.innerHTML = `
          <td>
            <input type="checkbox" class="checkbox" 
              ${selectedAssignments.has(index) ? 'checked' : ''}
              onchange="toggleSelect(${index})">
          </td>
          <td>
            <strong>${reviewer ? reviewer.name : assignment.reviewer_email}</strong><br>
            <small style="color: #999;">${assignment.reviewer_email}</small>
          </td>
          <td>${reviewer ? reviewer.department : '-'}</td>
          <td>
            <strong>${reviewee ? reviewee.name : assignment.reviewee_email}</strong><br>
            <small style="color: #999;">${assignment.reviewee_email}</small>
          </td>
          <td>${reviewee ? reviewee.department : '-'}</td>
          <td>
            <span class="badge ${assignment.target_type === 'EMPLOYEE' ? 'badge-employee' : 'badge-manager'}">
              ${assignment.target_type}
            </span>
          </td>
          <td>
            <span class="badge ${assignment.status === 'PENDING' ? 'badge-pending' : 'badge-completed'}">
              ${assignment.status}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button onclick="editAssignment(${index})" class="btn btn-primary btn-sm">S·ª≠a</button>
              <button onclick="deleteAssignment(${index})" class="btn btn-danger btn-sm">X√≥a</button>
            </div>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Render table nh√≥m theo Reviewer
    function renderTableGroupedByReviewer(tbody) {
      const groups = {};
      const duplicateIndices = detectDuplicates();
      
      filteredAssignments.forEach((assignment, index) => {
        const key = assignment.reviewer_email;
        if (!groups[key]) {
          groups[key] = [];
        }
        groups[key].push({ assignment, index });
      });

      let groupId = 0;
      Object.keys(groups).sort().forEach((reviewerEmail) => {
        const reviewer = allEmployees.find(e => e.email === reviewerEmail);
        const groupIndices = groups[reviewerEmail].map(g => g.index);
        
        // Sort: MANAGER items first, then EMPLOYEE
        const sortedItems = groups[reviewerEmail].sort((a, b) => {
          if (a.assignment.target_type === 'MANAGER' && b.assignment.target_type !== 'MANAGER') return -1;
          if (a.assignment.target_type !== 'MANAGER' && b.assignment.target_type === 'MANAGER') return 1;
          return 0;
        });

        // Count EMPLOYEE and MANAGER in this group
        const employeeCount = sortedItems.filter(item => item.assignment.target_type === 'EMPLOYEE').length;
        const managerCount = sortedItems.filter(item => item.assignment.target_type === 'MANAGER').length;

        const allChecked = groupIndices.every(idx => selectedAssignments.has(idx));
        const currentGroupId = `group-reviewer-${groupId}`;
        
        // Header row
        const headerRow = document.createElement('tr');
        headerRow.style.background = '#e3f2fd';
        headerRow.style.fontWeight = 'bold';
        headerRow.style.cursor = 'pointer';
        headerRow.className = 'group-header';
        headerRow.onclick = (e) => {
          if (e.target.type !== 'checkbox') {
            toggleGroupCollapse(currentGroupId);
          }
        };
        headerRow.innerHTML = `
          <td style="padding: 12px; width: 40px;">
            <input type="checkbox" class="checkbox group-checkbox" 
              ${allChecked ? 'checked' : ''}
              data-group-indices="${groupIndices.join(',')}"
              onclick="toggleGroupByCheckbox(this); event.stopPropagation();">
          </td>
          <td colspan="7" style="padding: 12px; border-left: 4px solid #2196F3; padding-left: 20px;">
            <span class="group-toggle-icon" data-group-id="${currentGroupId}">‚ñ∂</span>
            üë§ ${reviewer ? reviewer.name : reviewerEmail} (${reviewer ? reviewer.department : '-'}) - T·ªïng: ${groups[reviewerEmail].length} (üë® ${managerCount} | üë§ ${employeeCount})
          </td>
        `;
        tbody.appendChild(headerRow);

        // Data rows
        sortedItems.forEach(({ assignment, index }) => {
          const reviewee = allEmployees.find(e => e.email === assignment.reviewee_email);
          const isDuplicate = duplicateIndices.has(index);
          const isManager = assignment.target_type === 'MANAGER';

          const row = document.createElement('tr');
          row.className = `group-content ${currentGroupId}`;
          if (isDuplicate) {
            row.classList.add('duplicate-row');
          }
          if (isManager) {
            row.classList.add('manager-row');
          }
          row.style.display = 'none'; // M·∫∑c ƒë·ªãnh collapsed
          row.innerHTML = `
            <td>
              <input type="checkbox" class="checkbox" 
                ${selectedAssignments.has(index) ? 'checked' : ''}
                onchange="toggleSelect(${index})">
            </td>
            <td style="padding-left: 30px;">
              <strong>${reviewer ? reviewer.name : assignment.reviewer_email}</strong><br>
              <small style="color: #999;">${assignment.reviewer_email}</small>
            </td>
            <td>${reviewer ? reviewer.department : '-'}</td>
            <td>
              <strong>${reviewee ? reviewee.name : assignment.reviewee_email}</strong><br>
              <small style="color: #999;">${assignment.reviewee_email}</small>
            </td>
            <td>${reviewee ? reviewee.department : '-'}</td>
            <td>
              <span class="badge ${assignment.target_type === 'EMPLOYEE' ? 'badge-employee' : 'badge-manager'}">
                ${assignment.target_type}
              </span>
            </td>
            <td>
              <span class="badge ${assignment.status === 'PENDING' ? 'badge-pending' : 'badge-completed'}">
                ${assignment.status}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button onclick="editAssignment(${index})" class="btn btn-primary btn-sm">S·ª≠a</button>
                <button onclick="deleteAssignment(${index})" class="btn btn-danger btn-sm">X√≥a</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        groupId++;
      });
    }

    // Render table nh√≥m theo Reviewee
    function renderTableGroupedByReviewee(tbody) {
      const groups = {};
      const duplicateIndices = detectDuplicates();
      
      filteredAssignments.forEach((assignment, index) => {
        const key = assignment.reviewee_email;
        if (!groups[key]) {
          groups[key] = [];
        }
        groups[key].push({ assignment, index });
      });

      let groupId = 0;
      Object.keys(groups).sort().forEach((revieweeEmail) => {
        const reviewee = allEmployees.find(e => e.email === revieweeEmail);
        const groupIndices = groups[revieweeEmail].map(g => g.index);
        
        // Sort: MANAGER items first, then EMPLOYEE
        const sortedItems = groups[revieweeEmail].sort((a, b) => {
          if (a.assignment.target_type === 'MANAGER' && b.assignment.target_type !== 'MANAGER') return -1;
          if (a.assignment.target_type !== 'MANAGER' && b.assignment.target_type === 'MANAGER') return 1;
          return 0;
        });

        // Count EMPLOYEE and MANAGER in this group
        const employeeCount = sortedItems.filter(item => item.assignment.target_type === 'EMPLOYEE').length;
        const managerCount = sortedItems.filter(item => item.assignment.target_type === 'MANAGER').length;

        const allChecked = groupIndices.every(idx => selectedAssignments.has(idx));
        const currentGroupId = `group-reviewee-${groupId}`;
        
        // Header row
        const headerRow = document.createElement('tr');
        headerRow.style.background = '#f3e5f5';
        headerRow.style.fontWeight = 'bold';
        headerRow.style.cursor = 'pointer';
        headerRow.className = 'group-header';
        headerRow.onclick = (e) => {
          if (e.target.type !== 'checkbox') {
            toggleGroupCollapse(currentGroupId);
          }
        };
        headerRow.innerHTML = `
          <td style="padding: 12px; width: 40px;">
            <input type="checkbox" class="checkbox group-checkbox" 
              ${allChecked ? 'checked' : ''}
              data-group-indices="${groupIndices.join(',')}"
              onclick="toggleGroupByCheckbox(this); event.stopPropagation();">
          </td>
          <td colspan="7" style="padding: 12px; border-left: 4px solid #9C27B0; padding-left: 20px;">
            <span class="group-toggle-icon" data-group-id="${currentGroupId}">‚ñ∂</span>
            üë• ${reviewee ? reviewee.name : revieweeEmail} (${reviewee ? reviewee.department : '-'}) - T·ªïng: ${groups[revieweeEmail].length} (üë® ${managerCount} | üë§ ${employeeCount})
          </td>
        `;
        tbody.appendChild(headerRow);

        // Data rows
        sortedItems.forEach(({ assignment, index }) => {
          const reviewer = allEmployees.find(e => e.email === assignment.reviewer_email);
          const isDuplicate = duplicateIndices.has(index);
          const isManager = assignment.target_type === 'MANAGER';

          const row = document.createElement('tr');
          row.className = `group-content ${currentGroupId}`;
          if (isDuplicate) {
            row.classList.add('duplicate-row');
          }
          if (isManager) {
            row.classList.add('manager-row');
          }
          row.style.display = 'none'; // M·∫∑c ƒë·ªãnh collapsed
          row.innerHTML = `
            <td>
              <input type="checkbox" class="checkbox" 
                ${selectedAssignments.has(index) ? 'checked' : ''}
                onchange="toggleSelect(${index})">
            </td>
            <td>
              <strong>${reviewer ? reviewer.name : assignment.reviewer_email}</strong><br>
              <small style="color: #999;">${assignment.reviewer_email}</small>
            </td>
            <td>${reviewer ? reviewer.department : '-'}</td>
            <td style="padding-left: 30px;">
              <strong>${reviewee ? reviewee.name : assignment.reviewee_email}</strong><br>
              <small style="color: #999;">${assignment.reviewee_email}</small>
            </td>
            <td>${reviewee ? reviewee.department : '-'}</td>
            <td>
              <span class="badge ${assignment.target_type === 'EMPLOYEE' ? 'badge-employee' : 'badge-manager'}">
                ${assignment.target_type}
              </span>
            </td>
            <td>
              <span class="badge ${assignment.status === 'PENDING' ? 'badge-pending' : 'badge-completed'}">
                ${assignment.status}
              </span>
            </td>
            <td>
              <div class="action-buttons">
                <button onclick="editAssignment(${index})" class="btn btn-primary btn-sm">S·ª≠a</button>
                <button onclick="deleteAssignment(${index})" class="btn btn-danger btn-sm">X√≥a</button>
              </div>
            </td>
          `;
          tbody.appendChild(row);
        });
        
        groupId++;
      });
    }

    function toggleSelect(index) {
      if (selectedAssignments.has(index)) {
        selectedAssignments.delete(index);
      } else {
        selectedAssignments.add(index);
      }
      updateBulkActions();
    }

    // Toggle collapse/expand for a group
    function toggleGroupCollapse(groupId) {
      const contentRows = document.querySelectorAll(`.${groupId}`);
      const toggleIcon = document.querySelector(`[data-group-id="${groupId}"]`);
      
      let isCollapsed = contentRows[0]?.style.display === 'none';
      
      contentRows.forEach(row => {
        row.style.display = isCollapsed ? 'table-row' : 'none';
      });
      
      if (toggleIcon) {
        toggleIcon.textContent = isCollapsed ? '‚ñº' : '‚ñ∂';
      }
    }

    // Toggle select all in a group by clicking header checkbox
    function toggleGroupByCheckbox(checkbox) {
      const groupIndicesStr = checkbox.dataset.groupIndices;
      const groupIndices = groupIndicesStr.split(',').map(idx => parseInt(idx, 10));
      const allChecked = groupIndices.every(idx => selectedAssignments.has(idx));
      
      if (allChecked) {
        // Uncheck all items in group
        groupIndices.forEach(idx => selectedAssignments.delete(idx));
      } else {
        // Check all items in group
        groupIndices.forEach(idx => selectedAssignments.add(idx));
      }
      
      // Re-render table to update all checkboxes UI
      renderTable();
    }

    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      selectedAssignments.clear();
      
      if (checked) {
        filteredAssignments.forEach((_, index) => selectedAssignments.add(index));
      }
      
      renderTable();
    }

    function updateBulkActions() {
      const bulkActions = document.getElementById('bulkActions');
      const count = selectedAssignments.size;
      
      if (count > 0) {
        bulkActions.style.display = 'flex';
        document.getElementById('selectedCount').textContent = `${count} ƒë√°nh gi√° ƒë√£ ch·ªçn`;
      } else {
        bulkActions.style.display = 'none';
      }
    }

    function openAddModal() {
      editingIndex = -1;
      document.getElementById('modalTitle').textContent = 'Th√™m ƒê√°nh gi√°';
      
      // Reset mode to 2 (default: Reviewee Centric)
      currentMode = 2;
      
      // Show mode toggle section
      document.getElementById('modeToggleSection').style.display = 'block';
      
      // Show Mode 2 by default (Reviewee Centric)
      document.getElementById('singleMode').style.display = 'none';
      document.getElementById('bulkMode').style.display = 'none';
      document.getElementById('bulkMode2').style.display = 'block';
      
      // Disable required validation for hidden single mode fields
      document.getElementById('reviewerSelectSingle').removeAttribute('required');
      document.getElementById('revieweeSelectSingle').removeAttribute('required');
      document.getElementById('targetTypeSelectSingle').removeAttribute('required');
      
      // Disable required validation for hidden Mode 1 bulk mode fields
      document.getElementById('reviewerSelectBulk').removeAttribute('required');
      document.getElementById('targetTypeSelectBulk').removeAttribute('required');
      
      // Enable required validation for Mode 2 fields
      document.getElementById('revieweeSelectMode2').setAttribute('required', 'required');
      document.getElementById('targetTypeSelectMode2').setAttribute('required', 'required');
      
      // Reset both modes
      bulkSelectedReviewer = '';
      bulkSelectedTargetType = '';
      bulkSelectedReviewees.clear();
      bulkSelectedReviewee = '';
      bulkSelectedTargetTypeMode2 = '';
      bulkSelectedReviewers.clear();
      
      // Update toggle button text
      updateModeToggleButton();
      
      document.getElementById('assignmentForm').reset();
      document.getElementById('revieweeInfoMode2').textContent = '';
      document.getElementById('selectedReviewersList').style.display = 'none';
      document.getElementById('modalError').style.display = 'none';
      document.getElementById('assignmentModal').style.display = 'block';
      
      filterAndUpdateMode2ReviewerSelect();
      populateDepartmentFilterMode2();
      populateSelects();
    }

    // Toggle between Mode 1 (Reviewer Centric) and Mode 2 (Reviewee Centric)
    function toggleMode() {
      currentMode = currentMode === 1 ? 2 : 1;
      
      // Reset selected items when toggling
      bulkSelectedReviewer = '';
      bulkSelectedTargetType = '';
      bulkSelectedReviewees.clear();
      bulkSelectedReviewee = '';
      bulkSelectedTargetTypeMode2 = '';
      bulkSelectedReviewers.clear();
      
      // Reset form
      document.getElementById('assignmentForm').reset();
      document.getElementById('modalError').style.display = 'none';
      
      if (currentMode === 1) {
        // Show Mode 1 (Reviewer Centric - old bulk mode)
        document.getElementById('bulkMode').style.display = 'block';
        document.getElementById('bulkMode2').style.display = 'none';
        
        // Update required attributes
        document.getElementById('reviewerSelectBulk').setAttribute('required', 'required');
        document.getElementById('targetTypeSelectBulk').setAttribute('required', 'required');
        document.getElementById('revieweeSelectMode2').removeAttribute('required');
        document.getElementById('targetTypeSelectMode2').removeAttribute('required');
        
        document.getElementById('reviewerInfoBulk').textContent = '';
        document.getElementById('selectedRevieweesList').style.display = 'none';
        
        filterAndUpdateBulkRevieweeSelect();
      } else {
        // Show Mode 2 (Reviewee Centric)
        document.getElementById('bulkMode').style.display = 'none';
        document.getElementById('bulkMode2').style.display = 'block';
        
        // Update required attributes
        document.getElementById('reviewerSelectBulk').removeAttribute('required');
        document.getElementById('targetTypeSelectBulk').removeAttribute('required');
        document.getElementById('revieweeSelectMode2').setAttribute('required', 'required');
        document.getElementById('targetTypeSelectMode2').setAttribute('required', 'required');
        
        document.getElementById('revieweeInfoMode2').textContent = '';
        document.getElementById('selectedReviewersList').style.display = 'none';
        
        filterAndUpdateMode2ReviewerSelect();
      }
      
      updateModeToggleButton();
    }

    function updateModeToggleButton() {
      const btn = document.getElementById('modeToggleBtn');
      const desc = document.getElementById('modeDesc');
      const descText = document.getElementById('modeDescText');
      
      if (currentMode === 1) {
        btn.textContent = 'Ch·∫ø ƒë·ªô 1: Theo Ng∆∞·ªùi ƒë√°nh gi√°';
        desc.textContent = 'Ch·∫ø ƒë·ªô 1:';
        descText.textContent = 'Ch·ªçn 1 ng∆∞·ªùi ƒë√°nh gi√°, sau ƒë√≥ ch·ªçn nhi·ªÅu ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°';
      } else {
        btn.textContent = 'Ch·∫ø ƒë·ªô 2: Theo Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°';
        desc.textContent = 'Ch·∫ø ƒë·ªô 2:';
        descText.textContent = 'Ch·ªçn 1 ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°, sau ƒë√≥ ch·ªçn nhi·ªÅu ng∆∞·ªùi ƒë√°nh gi√°';
      }
    }

    function editAssignment(index) {
      editingIndex = index;
      const assignment = filteredAssignments[index];
      
      document.getElementById('modalTitle').textContent = 'S·ª≠a ƒê√°nh gi√°';
      
      // Hide mode toggle section for edit modal
      document.getElementById('modeToggleSection').style.display = 'none';
      
      // Show single mode
      document.getElementById('singleMode').style.display = 'block';
      document.getElementById('bulkMode').style.display = 'none';
      document.getElementById('bulkMode2').style.display = 'none';
      
      // Enable required validation for single mode fields
      document.getElementById('reviewerSelectSingle').setAttribute('required', 'required');
      document.getElementById('revieweeSelectSingle').setAttribute('required', 'required');
      document.getElementById('targetTypeSelectSingle').setAttribute('required', 'required');
      
      // Disable required validation for hidden bulk mode fields
      document.getElementById('reviewerSelectBulk').removeAttribute('required');
      document.getElementById('targetTypeSelectBulk').removeAttribute('required');
      document.getElementById('revieweeSelectMode2').removeAttribute('required');
      document.getElementById('targetTypeSelectMode2').removeAttribute('required');
      
      document.getElementById('reviewerSelectSingle').value = assignment.reviewer_email;
      document.getElementById('revieweeSelectSingle').value = assignment.reviewee_email;
      document.getElementById('targetTypeSelectSingle').value = assignment.target_type;
      document.getElementById('statusSelectSingle').value = assignment.status;
      
      // Trigger change events to show info
      document.getElementById('reviewerSelectSingle').dispatchEvent(new Event('change'));
      document.getElementById('revieweeSelectSingle').dispatchEvent(new Event('change'));
      
      document.getElementById('modalError').style.display = 'none';
      document.getElementById('assignmentModal').style.display = 'block';
    }

    function closeModal() {
      document.getElementById('assignmentModal').style.display = 'none';
      // Clear bulk mode state
      bulkSelectedReviewer = '';
      bulkSelectedTargetType = '';
      bulkSelectedReviewees.clear();
      // Clear mode 2 state
      bulkSelectedReviewee = '';
      bulkSelectedTargetTypeMode2 = '';
      bulkSelectedReviewers.clear();
    }

    function saveAssignment(event) {
      event.preventDefault();
      
      // Check if in single mode (edit) or bulk mode (add multiple)
      const isSingleMode = document.getElementById('singleMode').style.display !== 'none';
      
      if (isSingleMode) {
        // Single mode: edit existing
        saveSingleAssignment();
      } else if (currentMode === 1) {
        // Mode 1: Bulk assignments with fixed reviewer
        saveBulkAssignments();
      } else {
        // Mode 2: Bulk assignments with fixed reviewee
        saveBulkMode2Assignments();
      }
    }

    function saveSingleAssignment() {
      const reviewerEmail = document.getElementById('reviewerSelectSingle').value;
      const revieweeEmail = document.getElementById('revieweeSelectSingle').value;
      const targetType = document.getElementById('targetTypeSelectSingle').value;
      const status = document.getElementById('statusSelectSingle').value;

      // Validation
      if (reviewerEmail === revieweeEmail) {
        document.getElementById('modalError').textContent = 'Ng∆∞·ªùi ƒë√°nh gi√° v√† Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° kh√¥ng ƒë∆∞·ª£c tr√πng nhau!';
        document.getElementById('modalError').style.display = 'block';
        return;
      }

      const newAssignment = {
        reviewer_email: reviewerEmail,
        reviewee_email: revieweeEmail,
        target_type: targetType,
        status: status
      };

      if (editingIndex === -1) {
        // Check duplicate
        const isDuplicate = allAssignments.some(a => 
          a.reviewer_email === reviewerEmail &&
          a.reviewee_email === revieweeEmail &&
          a.target_type === targetType
        );

        if (isDuplicate) {
          document.getElementById('modalError').textContent = 'ƒê√°nh gi√° n√†y ƒë√£ t·ªìn t·∫°i!';
          document.getElementById('modalError').style.display = 'block';
          return;
        }

        allAssignments.push(newAssignment);
      } else {
        // Find and update in allAssignments
        const originalAssignment = filteredAssignments[editingIndex];
        const indexInAll = allAssignments.findIndex(a => 
          a.reviewer_email === originalAssignment.reviewer_email &&
          a.reviewee_email === originalAssignment.reviewee_email &&
          a.target_type === originalAssignment.target_type
        );
        
        if (indexInAll !== -1) {
          allAssignments[indexInAll] = newAssignment;
        }
      }

      closeModal();
      updateStats();
      populateFilters();
      applyFilters();
    }

    function saveBulkAssignments() {
      const reviewerEmail = document.getElementById('reviewerSelectBulk').value;
      const targetType = document.getElementById('targetTypeSelectBulk').value;

      // Validation
      if (!reviewerEmail || !targetType) {
        document.getElementById('modalError').textContent = 'Vui l√≤ng ch·ªçn Ng∆∞·ªùi ƒë√°nh gi√° v√† Lo·∫°i ƒë√°nh gi√°!';
        document.getElementById('modalError').style.display = 'block';
        return;
      }

      if (bulkSelectedReviewees.size === 0) {
        document.getElementById('modalError').textContent = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√°!';
        document.getElementById('modalError').style.display = 'block';
        return;
      }

      // Add multiple assignments
      bulkSelectedReviewees.forEach(revieweeEmail => {
        // Check if already exists
        const isDuplicate = allAssignments.some(a =>
          a.reviewer_email === reviewerEmail &&
          a.reviewee_email === revieweeEmail &&
          a.target_type === targetType
        );

        if (!isDuplicate) {
          allAssignments.push({
            reviewer_email: reviewerEmail,
            reviewee_email: revieweeEmail,
            target_type: targetType,
            status: 'PENDING',
            period: '2025'
          });
        }
      });

      const createdCount = bulkSelectedReviewees.size;
      closeModal();
      showSuccessWithGoogleSheetsOption(createdCount);
      updateStats();
      populateFilters();
      applyFilters();
    }

    function saveBulkMode2Assignments() {
      const revieweeEmail = document.getElementById('revieweeSelectMode2').value;
      const targetType = document.getElementById('targetTypeSelectMode2').value;

      // Validation
      if (!revieweeEmail || !targetType) {
        document.getElementById('modalError').textContent = 'Vui l√≤ng ch·ªçn Ng∆∞·ªùi ƒë∆∞·ª£c ƒë√°nh gi√° v√† Lo·∫°i ƒë√°nh gi√°!';
        document.getElementById('modalError').style.display = 'block';
        return;
      }

      if (bulkSelectedReviewers.size === 0) {
        document.getElementById('modalError').textContent = 'Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 Ng∆∞·ªùi ƒë√°nh gi√°!';
        document.getElementById('modalError').style.display = 'block';
        return;
      }

      // Add multiple assignments (same reviewee, multiple reviewers)
      let createdCount = 0;
      bulkSelectedReviewers.forEach(reviewerEmail => {
        // Check if already exists
        const isDuplicate = allAssignments.some(a =>
          a.reviewer_email === reviewerEmail &&
          a.reviewee_email === revieweeEmail &&
          a.target_type === targetType
        );

        if (!isDuplicate) {
          allAssignments.push({
            reviewer_email: reviewerEmail,
            reviewee_email: revieweeEmail,
            target_type: targetType,
            status: 'PENDING',
            period: '2025'
          });
          createdCount++;
        }
      });

      // Show success notification with Google Sheets suggestion button
      closeModal();
      showSuccessWithGoogleSheetsOption(createdCount);
      updateStats();
      populateFilters();
      applyFilters();
    }

    function showSuccessWithGoogleSheetsOption(count) {
      // Create a custom notification div
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 400px;
      `;
      notification.innerHTML = `
        <div style="margin-bottom: 12px; font-weight: 600;">
          ‚úÖ ƒê√£ t·∫°o th√†nh c√¥ng ${count} ƒë√°nh gi√°!
        </div>
        <button onclick="saveAllChanges()" class="btn btn-sm" style="background: white; color: #4CAF50; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: 600;">
          üíæ L∆∞u v√†o Google Sheet
        </button>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: white; cursor: pointer; margin-left: 8px; font-size: 18px; padding: 0; vertical-align: top;">‚úï</button>
      `;
      document.body.appendChild(notification);
      
      // Auto-remove after 10 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 10000);
    }

    function deleteAssignment(index) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a assignment n√†y?')) return;

      const assignment = filteredAssignments[index];
      const indexInAll = allAssignments.findIndex(a => 
        a.reviewer_email === assignment.reviewer_email &&
        a.reviewee_email === assignment.reviewee_email &&
        a.target_type === assignment.target_type
      );

      if (indexInAll !== -1) {
        allAssignments.splice(indexInAll, 1);
      }

      updateStats();
      populateFilters();
      applyFilters();
    }

    function deleteDuplicates() {
      const duplicateIndices = detectDuplicates();
      
      if (duplicateIndices.size === 0) {
        alert('Kh√¥ng c√≥ b·∫£n ghi tr√πng l·∫∑p n√†o!');
        return;
      }

      // T·∫°o danh s√°ch c√°c b·∫£n ghi s·∫Ω x√≥a
      const toDelete = Array.from(duplicateIndices).map(i => filteredAssignments[i]);
      
      // T·∫°o message hi·ªÉn th·ªã danh s√°ch
      let message = `T√¨m th·∫•y ${duplicateIndices.size} b·∫£n ghi tr√πng l·∫∑p (t·ª´ b·∫£n ghi th·ª© 2 tr·ªü ƒëi).\n\n`;
      message += 'Danh s√°ch s·∫Ω b·ªã x√≥a:\n';
      message += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      
      toDelete.forEach((assignment, idx) => {
        const reviewer = allEmployees.find(e => e.email === assignment.reviewer_email);
        const reviewee = allEmployees.find(e => e.email === assignment.reviewee_email);
        message += `${idx + 1}. ${reviewer?.name || assignment.reviewer_email} ‚Üí ${reviewee?.name || assignment.reviewee_email} (${assignment.target_type})\n`;
      });
      
      message += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
      message += '\nB·∫°n c√≥ ch·∫Øc mu·ªën x√≥a c√°c b·∫£n ghi n√†y?';

      if (!confirm(message)) return;

      // X√≥a c√°c b·∫£n ghi tr√πng
      toDelete.forEach(assignment => {
        const indexInAll = allAssignments.findIndex(a => 
          a.reviewer_email === assignment.reviewer_email &&
          a.reviewee_email === assignment.reviewee_email &&
          a.target_type === assignment.target_type
        );
        
        if (indexInAll !== -1) {
          allAssignments.splice(indexInAll, 1);
        }
      });

      alert(`ƒê√£ x√≥a ${toDelete.length} b·∫£n ghi tr√πng l·∫∑p!`);
      selectedAssignments.clear();
      updateStats();
      populateFilters();
      applyFilters();
    }

    function bulkDelete() {
      if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ${selectedAssignments.size} ƒë√°nh gi√° ƒë√£ ch·ªçn?`)) return;

      const toDelete = Array.from(selectedAssignments).map(i => filteredAssignments[i]);
      
      toDelete.forEach(assignment => {
        const indexInAll = allAssignments.findIndex(a => 
          a.reviewer_email === assignment.reviewer_email &&
          a.reviewee_email === assignment.reviewee_email &&
          a.target_type === assignment.target_type
        );
        
        if (indexInAll !== -1) {
          allAssignments.splice(indexInAll, 1);
        }
      });

      selectedAssignments.clear();
      updateStats();
      populateFilters();
      applyFilters();
    }

    function bulkUpdateStatus(newStatus) {
      if (!confirm(`C·∫≠p nh·∫≠t tr·∫°ng th√°i ${selectedAssignments.size} assignment th√†nh ${newStatus}?`)) return;

      Array.from(selectedAssignments).forEach(index => {
        const assignment = filteredAssignments[index];
        const indexInAll = allAssignments.findIndex(a => 
          a.reviewer_email === assignment.reviewer_email &&
          a.reviewee_email === assignment.reviewee_email &&
          a.target_type === assignment.target_type
        );
        
        if (indexInAll !== -1) {
          allAssignments[indexInAll].status = newStatus;
        }
      });

      selectedAssignments.clear();
      updateStats();
      applyFilters();
    }

    async function saveAllChanges() {
      if (!confirm('L∆∞u t·∫•t c·∫£ thay ƒë·ªïi v√†o Google Sheets?')) return;

      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';

        // Use SIRA_API instead of direct fetch
        const data = await window.SIRA_API.updateAllAssignments(allAssignments);
        
        if (data.success) {
          alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
          await loadData();
        } else {
          throw new Error(data.error || 'L·ªói kh√¥ng x√°c ƒë·ªãnh');
        }
      } catch (error) {
        console.error('Error saving:', error);
        alert('‚ùå L·ªói khi l∆∞u: ' + error.message);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      }
    }

    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }
    }

    // Make functions available globally
    window.loadData = loadData;
    window.applyFilters = applyFilters;
    window.resetFilters = resetFilters;
    window.toggleSelect = toggleSelect;
    window.toggleSelectAll = toggleSelectAll;
    window.openAddModal = openAddModal;
    window.editAssignment = editAssignment;
    window.deleteAssignment = deleteAssignment;
    window.closeModal = closeModal;
    window.saveAssignment = saveAssignment;
    window.saveSingleAssignment = saveSingleAssignment;
    window.saveBulkAssignments = saveBulkAssignments;
    window.bulkDelete = bulkDelete;
    window.bulkUpdateStatus = bulkUpdateStatus;
    window.saveAllChanges = saveAllChanges;
    window.logout = logout;
    window.onBulkReviewerChange = onBulkReviewerChange;
    window.onBulkTargetTypeChange = onBulkTargetTypeChange;
    window.onBulkRevieweeSelect = onBulkRevieweeSelect;
    window.onBulkDepartmentChange = onBulkDepartmentChange;
    window.removeBulkReviewee = removeBulkReviewee;
    window.renderBulkSelectedReviewees = renderBulkSelectedReviewees;
    window.filterAndUpdateBulkRevieweeSelect = filterAndUpdateBulkRevieweeSelect;
    window.selectAllAvailableReviewees = selectAllAvailableReviewees;
    window.filterRevieweeDropdown = filterRevieweeDropdown;
    
    // Mode 2 functions
    window.toggleMode = toggleMode;
    window.updateModeToggleButton = updateModeToggleButton;
    window.onMode2RevieweeChange = onMode2RevieweeChange;
    window.onMode2TargetTypeChange = onMode2TargetTypeChange;
    window.onMode2DepartmentChange = onMode2DepartmentChange;
    window.onMode2ReviewerSelect = onMode2ReviewerSelect;
    window.filterReviewerDropdownMode2 = filterReviewerDropdownMode2;
    window.selectAllAvailableReviewersMode2 = selectAllAvailableReviewersMode2;
    window.renderMode2SelectedReviewers = renderMode2SelectedReviewers;
    window.removeMode2SelectedReviewer = removeMode2SelectedReviewer;
    window.filterAndUpdateMode2ReviewerSelect = filterAndUpdateMode2ReviewerSelect;
    window.saveBulkMode2Assignments = saveBulkMode2Assignments;
    window.showSuccessWithGoogleSheetsOption = showSuccessWithGoogleSheetsOption;
    
    window.toggleDetailReport = toggleDetailReport;
    window.renderDetailReport = renderDetailReport;

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('assignmentModal');
      if (event.target === modal) {
        closeModal();
      }
    };
  </script>
</body>
</html>
