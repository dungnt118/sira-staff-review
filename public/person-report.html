<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìÑ B√°o c√°o chi ti·∫øt nh√¢n s·ª± - SIRA</title>
  <style>
    :root {
      --bg: linear-gradient(135deg, #1d1e26 0%, #0f172a 100%);
      --card: #0f1724;
      --card-2: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #f59e0b;
      --border: rgba(255,255,255,0.08);
      --good: #22c55e;
      --mid: #3b82f6;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      padding: 20px;
    }
    .shell { max-width: 1180px; margin: 0 auto; }
    .header {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      padding: 16px 18px; border-radius: 14px; background: rgba(17,24,39,0.75);
      border: 1px solid var(--border); backdrop-filter: blur(8px);
    }
    .title { display: flex; align-items: center; gap: 12px; font-size: 19px; font-weight: 800; }
    .pill { padding: 6px 10px; border-radius: 10px; font-size: 12px; color: #0f1724; background: var(--accent); font-weight: 700; }
    .actions { display: flex; gap: 10px; }
    .btn { border: none; border-radius: 10px; padding: 9px 14px; cursor: pointer; font-weight: 700; transition: all .2s; }
    .btn-ghost { background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid var(--border); }
    .btn-ghost:hover { border-color: rgba(255,255,255,0.2); }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
    .grid { display: grid; gap: 14px; }
    .grid-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .section-title { display: flex; align-items: center; gap: 8px; font-size: 15px; margin: 0 0 10px; color: #e0f2fe; }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; text-align: left; font-size: 14px; }
    th { color: var(--muted); border-bottom: 1px solid var(--border); font-weight: 700; }
    tr + tr td { border-top: 1px solid var(--border); }

    .metric { display: flex; justify-content: space-between; align-items: center; }
    .metric .value { font-size: 28px; font-weight: 800; }
    .metric .label { color: var(--muted); font-size: 13px; }
    .badge { padding: 5px 9px; border-radius: 9px; font-weight: 700; font-size: 12px; }
    .badge-good { background: rgba(34,197,94,0.2); color: var(--good); }
    .badge-mid { background: rgba(59,130,246,0.2); color: var(--mid); }
    .muted { color: var(--muted); }
    .hidden { display: none !important; }
    .loader { width: 44px; height: 44px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .reviewer-list { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
    .reviewer-item { 
      background: var(--card-2); 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      padding: 10px 12px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .reviewer-item:hover { 
      border-color: var(--accent); 
      background: rgba(245, 158, 11, 0.05); 
    }
    .reviewer-name { font-weight: 600; color: #fff; }
    .reviewer-email { color: var(--muted); font-size: 12px; margin-top: 2px; }
    .view-icon { color: var(--accent); font-size: 18px; }

    .assignments-list { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .section-toggle { margin-left: auto; background: rgba(255,255,255,0.08); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 4px 10px; font-size: 12px; cursor: pointer; font-weight: 700; }
    .section-toggle:hover { border-color: rgba(255,255,255,0.2); }
    .assignment-item {
      background: var(--card-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .assignment-main { display: flex; flex-direction: column; gap: 4px; }
    .assignment-name { font-weight: 700; color: #fff; }
    .assignment-meta { color: var(--muted); font-size: 12px; }
    .status-chip { padding: 4px 8px; border-radius: 8px; font-weight: 700; font-size: 11px; }
    .status-done { background: rgba(34,197,94,0.2); color: var(--good); }
    .status-pending { background: rgba(59,130,246,0.2); color: var(--mid); }
    .btn-view { background: rgba(245, 158, 11, 0.15); color: var(--accent); border: 1px solid rgba(245, 158, 11, 0.35); border-radius: 8px; padding: 6px 10px; font-weight: 700; cursor: pointer; }

    @media (max-width: 768px) { .header { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="title">
        <span style="font-size:22px">üìÑ</span>
        <div>
          <div>B√°o c√°o chi ti·∫øt nh√¢n s·ª±</div>
          <div class="pill" id="personName">...</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost" onclick="history.back()">‚¨ÖÔ∏è Quay l·∫°i</button>
        <button class="btn btn-ghost" onclick="location.href='reports.html'">üìä T·ªïng quan</button>
      </div>
    </div>

    <div id="loading" class="card" style="margin-top:14px; text-align:center;">
      <div class="loader"></div>
      <div class="muted">ƒêang t·∫£i b√°o c√°o...</div>
    </div>
    <div id="error" class="card hidden" style="margin-top:14px; color:#f87171;"></div>

    <div id="content" class="hidden" style="margin-top:14px;">
      <div class="card">
        <div class="section-title">üë§ Th√¥ng tin</div>
        <div class="metric">
          <div>
            <div class="label">T√™n</div>
            <div class="value" id="infoName">-</div>
          </div>
          <div class="badge badge-mid" id="infoEmail">-</div>
        </div>
        <div style="margin-top:12px;" class="muted" id="infoMeta">-</div>
      </div>
    </div>

    <div id="reports" class="grid" style="margin-top:14px;"></div>
  </div>

  <script src="js/config.js"></script>
  
  <!-- Auto cache busting -->
  <script>
    (function() {
      const CURRENT_VERSION = window.SIRA_CONFIG.VERSION;
      const storedVersion = localStorage.getItem('app_version');
      
      if (storedVersion && storedVersion !== CURRENT_VERSION) {
        console.log('üîÑ Ph√°t hi·ªán phi√™n b·∫£n m·ªõi (' + CURRENT_VERSION + '), ƒëang l√†m m·ªõi cache...');
        localStorage.setItem('app_version', CURRENT_VERSION);
        location.reload(true);
      } else {
        localStorage.setItem('app_version', CURRENT_VERSION);
      }
    })();
  </script>
  
  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    function requireAdmin() {
      const raw = localStorage.getItem('currentUser');
      if (!raw) { window.location.href = 'index.html'; return null; }
      const parsed = JSON.parse(raw);
      const role = (parsed?.employee?.role || sessionStorage.getItem('userRole') || 'USER').toUpperCase();
      sessionStorage.setItem('userRole', role);
      if (role !== 'ADMIN') { window.location.href = 'dashboard.html'; return null; }
      return { ...parsed, employee: { ...parsed.employee, role } };
    }

    function setText(id, value) { const el = document.getElementById(id); if (el) el.textContent = value; }

    function formatScore(num) {
      if (num == null || isNaN(num)) return '-';
      return Math.round(num * 100) / 100;
    }

    function renderSummaryCard(title, avgCriteriaScore, avgTotalScore, evalCount) {
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'section-title';
      header.innerHTML = title;
      card.appendChild(header);

      const metric1 = document.createElement('div');
      metric1.className = 'metric';
      metric1.innerHTML = `<div class="label">ƒêi·ªÉm TB ti√™u ch√≠</div><div class="value">${formatScore(avgCriteriaScore)}</div>`;
      card.appendChild(metric1);

      const metric2 = document.createElement('div');
      metric2.className = 'metric';
      metric2.innerHTML = `<div class="label">ƒêi·ªÉm TB (t·ªïng)</div><div class="value">${formatScore(avgTotalScore)}</div>`;
      card.appendChild(metric2);

      const metric3 = document.createElement('div');
      metric3.className = 'metric';
      metric3.innerHTML = `<div class="label">S·ªë l·∫ßn ƒë√°nh gi√°</div><div class="value">${evalCount}</div>`;
      card.appendChild(metric3);

      return card;
    }

    function renderReviewersList(reviewers, targetType, revieweeEmail) {
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'section-title';
      const typeLabel = targetType === 'EMPLOYEE' ? 'Nh√¢n vi√™n' : 'L√£nh ƒë·∫°o';
      header.innerHTML = `üë• Ng∆∞·ªùi ƒë√°nh gi√° (${typeLabel})`;
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'section-toggle';
      toggleBtn.type = 'button';
      toggleBtn.textContent = 'M·ªü';
      header.appendChild(toggleBtn);
      card.appendChild(header);

      if (!reviewers || reviewers.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Ch∆∞a c√≥ ng∆∞·ªùi ƒë√°nh gi√°';
        card.appendChild(empty);
        return card;
      }

      const list = document.createElement('div');
      list.className = 'reviewer-list hidden';

      reviewers.forEach(reviewer => {
        const item = document.createElement('div');
        item.className = 'reviewer-item';
        item.onclick = () => {
          const url = `evaluation.html?reviewer_email=${encodeURIComponent(reviewer.email)}&reviewee_email=${encodeURIComponent(revieweeEmail)}&target_type=${targetType}&mode=view`;
          window.location.href = url;
        };
        
        item.innerHTML = `
          <div>
            <div class="reviewer-name">${reviewer.name}</div>
            <div class="reviewer-email">${reviewer.email}</div>
          </div>
          <div class="view-icon">üëÅÔ∏è</div>
        `;
        list.appendChild(item);
      });

      card.appendChild(list);

      toggleBtn.onclick = () => {
        const isHidden = list.classList.contains('hidden');
        if (isHidden) {
          list.classList.remove('hidden');
          toggleBtn.textContent = 'Thu g·ªçn';
        } else {
          list.classList.add('hidden');
          toggleBtn.textContent = 'M·ªü';
        }
      };
      return card;
    }

    function renderReviewedAssignments(assignments, targetType, reviewerEmail) {
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'section-title';
      const typeLabel = targetType === 'EMPLOYEE' ? 'Nh√¢n vi√™n' : 'L√£nh ƒë·∫°o';
      
      // T√≠nh s·ªë nhi·ªám v·ª• ho√†n th√†nh
      const completed = (assignments || []).filter(a => (a.status || '').toUpperCase() === 'COMPLETED').length;
      const total = (assignments || []).length;
      const statsText = total > 0 ? ` (${completed}/${total})` : '';
      
      header.innerHTML = `üßæ Nhi·ªám v·ª• (${typeLabel})${statsText}`;
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'section-toggle';
      toggleBtn.type = 'button';
      toggleBtn.textContent = 'M·ªü';
      header.appendChild(toggleBtn);
      card.appendChild(header);

      if (!assignments || assignments.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Ch∆∞a c√≥ nhi·ªám v·ª•.';
        card.appendChild(empty);
        return card;
      }

      const list = document.createElement('div');
      list.className = 'assignments-list hidden';

      assignments.forEach(item => {
        const row = document.createElement('div');
        row.className = 'assignment-item';

        const name = item.reviewee?.name || item.reviewee_email;
        const email = item.reviewee?.email || item.reviewee_email;
        const meta = [item.reviewee?.department, item.reviewee?.position].filter(Boolean).join(' ‚Ä¢ ');

        const isCompleted = (item.status || '').toUpperCase() === 'COMPLETED';
        const statusLabel = isCompleted ? 'ƒê√£ ho√†n th√†nh' : 'Ch∆∞a ho√†n th√†nh';
        const statusClass = isCompleted ? 'status-done' : 'status-pending';

        row.innerHTML = `
          <div class="assignment-main">
            <div class="assignment-name">${name}</div>
            <div class="assignment-meta">${email}${meta ? ' ‚Ä¢ ' + meta : ''}</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px;">
            <span class="status-chip ${statusClass}">${statusLabel}</span>
            <button class="btn-view">Xem</button>
          </div>
        `;

        const btn = row.querySelector('.btn-view');
        btn.onclick = () => {
          const url = `evaluation.html?mode=view&reviewer_email=${encodeURIComponent(reviewerEmail)}&reviewee_email=${encodeURIComponent(item.reviewee_email)}&target_type=${targetType}`;
          window.location.href = url;
        };

        list.appendChild(row);
      });

      card.appendChild(list);

      toggleBtn.onclick = () => {
        const isHidden = list.classList.contains('hidden');
        if (isHidden) {
          list.classList.remove('hidden');
          toggleBtn.textContent = 'Thu g·ªçn';
        } else {
          list.classList.add('hidden');
          toggleBtn.textContent = 'M·ªü';
        }
      };
      return card;
    }

    function renderTargetWithHierarchy(targetData, title) {
      const card = document.createElement('div');
      card.className = 'card';
      const header = document.createElement('div');
      header.className = 'section-title';
      header.innerHTML = title;
      card.appendChild(header);

      const categories = targetData.categories || [];
      const otherCriteria = targetData.criteria || [];
      const hasData = categories.length > 0 || otherCriteria.length > 0;

      if (!hasData) {
        const empty = document.createElement('div');
        empty.className = 'muted';
        empty.textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu ƒë√°nh gi√°';
        card.appendChild(empty);
        return card;
      }

      // T·∫°o table duy nh·∫•t cho to√†n b·ªô ti√™u ch√≠
      const table = document.createElement('table');
      table.innerHTML = `
        <thead>
          <tr><th>Ti√™u ch√≠ / Nh√≥m</th><th>ƒêi·ªÉm TB</th><th>Max</th><th>Ng∆∞·ªùi ƒë√°nh gi√°</th></tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector('tbody');

      // Render c√°c categories v·ªõi sub-criteria
      for (const cat of categories) {
        // H√†ng nh√≥m (category)
        const catRow = document.createElement('tr');
        catRow.style.cssText = 'background: rgba(59, 130, 246, 0.1); font-weight: 700;';
        catRow.innerHTML = `
          <td style="padding-left: 8px; color: #3b82f6;">${cat.category_name}</td>
          <td style="color: #3b82f6;">${cat.average}</td>
          <td style="color: #3b82f6;">-</td>
          <td style="color: #3b82f6;">-</td>
        `;
        tbody.appendChild(catRow);

        // H√†ng con (sub-criteria)
        for (const subC of cat.sub_criteria) {
          const subRow = document.createElement('tr');
          subRow.style.paddingLeft = '12px';
          subRow.innerHTML = `
            <td style="padding-left: 20px;">${subC.criteria_name}</td>
            <td>${subC.average}</td>
            <td>5</td>
            <td>${subC.count || 0}</td>
          `;
          tbody.appendChild(subRow);
        }
      }

      // Render c√°c ti√™u ch√≠ kh√¥ng thu·ªôc nh√≥m (n·∫øu c√≥)
      if (otherCriteria.length > 0) {
        // Divider h√†ng n·∫øu c√≥ c·∫£ categories v√† other criteria
        if (categories.length > 0) {
          const dividerRow = document.createElement('tr');
          dividerRow.innerHTML = '<td colspan="4" style="height: 1px; background: rgba(255,255,255,0.1); padding: 0;"></td>';
          tbody.appendChild(dividerRow);
        }

        // H√†ng "Ti√™u ch√≠ kh√°c" n·∫øu c√≥ categories
        if (categories.length > 0) {
          const otherHeaderRow = document.createElement('tr');
          otherHeaderRow.style.cssText = 'background: rgba(156, 163, 175, 0.1); font-weight: 700;';
          otherHeaderRow.innerHTML = `
            <td style="padding-left: 8px; color: #9ca3af;">Ti√™u ch√≠ kh√°c</td>
            <td style="color: #9ca3af;">-</td>
            <td style="color: #9ca3af;">-</td>
            <td style="color: #9ca3af;">-</td>
          `;
          tbody.appendChild(otherHeaderRow);
        }

        // Sub-rows cho other criteria
        for (const c of otherCriteria) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td style="padding-left: ${categories.length > 0 ? '20px' : '8px'}">${c.criteria_name}</td>
            <td>${c.average}</td>
            <td>5</td>
            <td>${c.count || 0}</td>
          `;
          tbody.appendChild(row);
        }
      }

      card.appendChild(table);
      return card;
    }

    async function loadPersonReport() {
      const adminUser = requireAdmin();
      if (!adminUser) return;
      const revieweeEmail = getParam('reviewee_email');
      if (!revieweeEmail) { window.location.href = 'reports.html'; return; }

      const loading = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const content = document.getElementById('content');
      const reports = document.getElementById('reports');

      loading.classList.remove('hidden');
      errorEl.classList.add('hidden');
      reports.innerHTML = '';

      try {
        const resp = await window.SIRA_API.getPersonReport(adminUser.auth.email, revieweeEmail);
        if (!resp.success) throw new Error(resp.error || 'Kh√¥ng l·∫•y ƒë∆∞·ª£c b√°o c√°o');
        const data = resp.data || {};
        const rv = data.reviewee || { email: revieweeEmail };

        document.getElementById('personName').textContent = rv.name || rv.email;
        setText('infoName', rv.name || rv.email);
        setText('infoEmail', rv.email || '');
        setText('infoMeta', `${rv.department || ''} ${rv.position ? '‚Ä¢ ' + rv.position : ''}`.trim());

        // Render th√¥ng tin nh√¢n vi√™n
        loading.classList.add('hidden');
        content.classList.remove('hidden');

        // Render danh s√°ch ƒë√£ ƒë√°nh gi√° (theo assignments)
        const reviewsGiven = data.reviewsGiven || {};
        const reviewerEmail = rv.email || revieweeEmail;

        reports.appendChild(renderReviewedAssignments(reviewsGiven.EMPLOYEE || [], 'EMPLOYEE', reviewerEmail));
        reports.appendChild(renderReviewedAssignments(reviewsGiven.MANAGER || [], 'MANAGER', reviewerEmail));

        // Render b√°o c√°o theo t·ª´ng target_type
        const targets = data.targets || {};
        
        // B√°o c√°o Nh√¢n vi√™n
        if (targets.EMPLOYEE) {
          const empTarget = targets.EMPLOYEE;
          reports.appendChild(renderSummaryCard(
            'üë§ B√°o c√°o Nh√¢n vi√™n',
            empTarget.avgCriteriaScore || 0,
            empTarget.avgTotalScore || empTarget.averageScore || 0,
            empTarget.evaluationCount || 0
          ));
          reports.appendChild(renderReviewersList(empTarget.reviewers, 'EMPLOYEE', revieweeEmail));
          reports.appendChild(renderTargetWithHierarchy(empTarget, 'üìä Chi ti·∫øt ti√™u ch√≠ Nh√¢n vi√™n'));
        }

        // B√°o c√°o L√£nh ƒë·∫°o
        if (targets.MANAGER) {
          const mgTarget = targets.MANAGER;
          reports.appendChild(renderSummaryCard(
            'üëî B√°o c√°o L√£nh ƒë·∫°o',
            mgTarget.avgCriteriaScore || 0,
            mgTarget.avgTotalScore || mgTarget.averageScore || 0,
            mgTarget.evaluationCount || 0
          ));
          reports.appendChild(renderReviewersList(mgTarget.reviewers, 'MANAGER', revieweeEmail));
          reports.appendChild(renderTargetWithHierarchy(mgTarget, 'üìä Chi ti·∫øt ti√™u ch√≠ L√£nh ƒë·∫°o'));
        }

        // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu
        if (!targets.EMPLOYEE && !targets.MANAGER) {
          const empty = document.createElement('div');
          empty.className = 'card';
          empty.innerHTML = '<div class="muted" style="text-align:center;">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o</div>';
          reports.appendChild(empty);
        }
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'L·ªói: ' + err.message;
        errorEl.classList.remove('hidden');
        loading.classList.add('hidden');
      }
    }

    document.addEventListener('DOMContentLoaded', loadPersonReport);
  </script>
</body>
</html>
