<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>ƒê√°nh gi√° nh√¢n vi√™n - SIRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .header h1 {
      margin: 0;
      color: #333;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
    }
    
    .nav-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    
    .nav-btn:hover {
      background: #1976D2;
    }
    
    .main-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .loading {
      text-align: center;
      color: #666;
      padding: 40px;
      font-style: italic;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .reviewee-info {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      border-left: 5px solid #4CAF50;
    }
    
    .reviewee-info h2 {
      margin: 0 0 15px 0;
      color: #333;
    }
    
    .reviewee-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .reviewee-details .label {
      font-weight: bold;
      color: #555;
    }
    
    .reviewee-details .value {
      color: #333;
    }
    
    .assignment-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #2196F3;
    }
    
    .assignment-info h3 {
      margin: 0 0 10px 0;
      color: #1976D2;
    }
    
    .form-section {
      margin-bottom: 30px;
    }
    
    .form-section h3 {
      color: #333;
      border-bottom: 2px solid #4CAF50;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .criterion-item {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
    }
    
    .criterion-header {
      margin-bottom: 15px;
    }
    
    .criterion-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin: 0 0 5px 0;
    }
    
    .criterion-description {
      color: #666;
      font-size: 14px;
      margin: 0 0 5px 0;
    }
    
    .criterion-weight {
      font-size: 12px;
      color: #999;
      font-style: italic;
    }
    
    .input-group {
      margin-top: 15px;
    }
    
    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    
    .scale-input {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .scale-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }
    
    .scale-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }
    
    .scale-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
      border: none;
    }
    
    .scale-value {
      font-weight: bold;
      font-size: 18px;
      color: #4CAF50;
      min-width: 30px;
      text-align: center;
    }
    
    .scale-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    .comment-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
    }
    
    .comment-textarea:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
    }
    
    .form-actions {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-top: 30px;
    }
    
    .btn {
      display: inline-block;
      padding: 12px 30px;
      margin: 0 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      text-decoration: none;
      transition: background 0.3s;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-primary:hover {
      background: #45a049;
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background: #757575;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #616161;
    }
    
    .progress-info {
      background: #fff3e0;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #ff9800;
      margin-bottom: 20px;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #ddd;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: #4CAF50;
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      margin: 20px 0;
    }
    
    .success-message {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
      margin: 20px 0;
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .reviewee-details {
        grid-template-columns: 1fr;
      }
      
      .scale-input {
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      
      .btn {
        width: 100%;
        margin: 5px 0;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>‚≠ê ƒê√°nh gi√° nh√¢n vi√™n</h1>
    <div class="nav-buttons">
      <a href="dashboard.html" class="nav-btn">üìã Dashboard</a>
      <a href="welcome.html" class="nav-btn">üè† Trang ch·ªß</a>
    </div>
  </div>

  <div class="main-content">
    <!-- Loading state -->
    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <div>ƒêang t·∫£i form ƒë√°nh gi√°...</div>
    </div>

    <!-- Error state -->
    <div id="error-state" style="display: none;">
      <div class="error-message">
        <h3>‚ö†Ô∏è C√≥ l·ªói x·∫£y ra</h3>
        <p id="error-message"></p>
        <a href="dashboard.html" class="btn btn-secondary">‚Üê Quay l·∫°i Dashboard</a>
      </div>
    </div>

    <!-- Main form content -->
    <div id="form-content" style="display: none;">
      <!-- Reviewee information -->
      <div id="reviewee-info" class="reviewee-info">
        <h2>üë§ Th√¥ng tin nh√¢n vi√™n ƒë∆∞·ª£c ƒë√°nh gi√°</h2>
        <div class="reviewee-details">
          <span class="label">T√™n:</span>
          <span class="value" id="reviewee-name"></span>
          
          <span class="label">Email:</span>
          <span class="value" id="reviewee-email"></span>
          
          <span class="label">Ph√≤ng ban:</span>
          <span class="value" id="reviewee-department"></span>
          
          <span class="label">Ch·ª©c v·ª•:</span>
          <span class="value" id="reviewee-position"></span>
        </div>
      </div>

      <!-- Assignment info -->
      <div class="assignment-info">
        <h3>üìù Th√¥ng tin ph√¢n c√¥ng</h3>
        <p><strong>K·ª≥ ƒë√°nh gi√°:</strong> <span id="assignment-period"></span></p>
        <p><strong>Nh√≥m ti√™u ch√≠:</strong> <span id="assignment-criteria-group"></span></p>
      </div>

      <!-- Progress indicator -->
      <div class="progress-info">
        <p><strong>Ti·∫øn ƒë·ªô ho√†n th√†nh:</strong> <span id="progress-text">0/0 ti√™u ch√≠</span></p>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <!-- Review form -->
      <form id="review-form">
        <div class="form-section">
          <h3>üìä C√°c ti√™u ch√≠ ƒë√°nh gi√°</h3>
          <div id="criteria-container">
            <!-- Criteria will be loaded here -->
          </div>
        </div>

        <!-- Form actions -->
        <div class="form-actions">
          <button type="button" id="save-draft" class="btn btn-secondary">
            üíæ L∆∞u nh√°p
          </button>
          <button type="submit" id="submit-review" class="btn btn-primary">
            ‚úÖ N·ªôp ƒë√°nh gi√°
          </button>
        </div>
      </form>

      <!-- Messages -->
      <div id="message-area"></div>
    </div>
  </div>

  <!-- Load config first -->
  <script src="js/config.js"></script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    const app = initializeApp(window.SIRA_CONFIG.FIREBASE);
    const auth = getAuth(app);

    let currentAssignment = null;
    let criteria = [];
    let reviewData = {};

    // Ki·ªÉm tra authentication
    function checkAuth() {
      const savedUser = localStorage.getItem('currentUser');
      if (!savedUser) {
        alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. ƒêang chuy·ªÉn h∆∞·ªõng...');
        window.location.href = 'index.html';
        return null;
      }
      return JSON.parse(savedUser);
    }

    // L·∫•y assignment ID t·ª´ URL
    function getAssignmentId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('assignment');
    }

    // Hi·ªÉn th·ªã l·ªói
    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('form-content').style.display = 'none';
      document.getElementById('error-message').textContent = message;
      document.getElementById('error-state').style.display = 'block';
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showMessage(message, type = 'success') {
      const messageArea = document.getElementById('message-area');
      const className = type === 'success' ? 'success-message' : 'error-message';
      messageArea.innerHTML = `<div class="${className}">${message}</div>`;
      
      // Auto hide after 5 seconds
      setTimeout(() => {
        messageArea.innerHTML = '';
      }, 5000);
    }

    // Load assignment v√† criteria
    async function loadReviewData() {
      const userData = checkAuth();
      const assignmentId = getAssignmentId();
      
      if (!userData || !assignmentId) {
        showError('Th√¥ng tin kh√¥ng h·ª£p l·ªá. Vui l√≤ng quay l·∫°i dashboard.');
        return;
      }

      try {
        // L·∫•y danh s√°ch assignments ƒë·ªÉ t√¨m assignment c·ª• th·ªÉ
        const assignmentResult = await window.SIRA_API.getAssignments(userData.auth.email);
        
        if (!assignmentResult.success) {
          throw new Error(assignmentResult.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin assignment');
        }

        // T√¨m assignment theo ID
        currentAssignment = assignmentResult.assignments.find(a => a.assignment_id === assignmentId);
        
        if (!currentAssignment) {
          throw new Error('Kh√¥ng t√¨m th·∫•y assignment n√†y ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p');
        }

        // Ki·ªÉm tra xem ƒë√£ ho√†n th√†nh ch∆∞a
        if (currentAssignment.completed) {
          showError('B·∫°n ƒë√£ ho√†n th√†nh ƒë√°nh gi√° n√†y r·ªìi. Kh√¥ng th·ªÉ ch·ªânh s·ª≠a.');
          return;
        }

        // L·∫•y criteria
        const criteriaResult = await window.SIRA_API.getCriteria(currentAssignment.criteria_group);
        
        if (!criteriaResult.success) {
          throw new Error(criteriaResult.message || 'Kh√¥ng th·ªÉ t·∫£i ti√™u ch√≠ ƒë√°nh gi√°');
        }

        criteria = criteriaResult.criteria;

        if (criteria.length === 0) {
          throw new Error('Kh√¥ng c√≥ ti√™u ch√≠ ƒë√°nh gi√° n√†o cho nh√≥m n√†y');
        }

        // Hi·ªÉn th·ªã th√¥ng tin
        displayReviewInfo();
        generateForm();

      } catch (error) {
        console.error('Load review data error:', error);
        showError(`C√≥ l·ªói x·∫£y ra: ${error.message}`);
      }
    }

    // Hi·ªÉn th·ªã th√¥ng tin assignment v√† reviewee
    function displayReviewInfo() {
      // Assignment info
      document.getElementById('assignment-period').textContent = currentAssignment.period;
      document.getElementById('assignment-criteria-group').textContent = currentAssignment.criteria_group;

      // Reviewee info
      if (currentAssignment.reviewee) {
        document.getElementById('reviewee-name').textContent = currentAssignment.reviewee.name;
        document.getElementById('reviewee-email').textContent = currentAssignment.reviewee.email;
        document.getElementById('reviewee-department').textContent = currentAssignment.reviewee.department;
        document.getElementById('reviewee-position').textContent = currentAssignment.reviewee.position;
      }

      updateProgress();
    }

    // T·∫°o form ƒë·ªông
    function generateForm() {
      const container = document.getElementById('criteria-container');
      
      const criteriaHTML = criteria.map((criterion, index) => {
        const inputHTML = generateInputForCriterion(criterion);
        
        return `
          <div class="criterion-item" data-criterion-id="${criterion.criteria_id}">
            <div class="criterion-header">
              <h4 class="criterion-name">${criterion.criteria_name}</h4>
              <p class="criterion-description">${criterion.description}</p>
              <span class="criterion-weight">Tr·ªçng s·ªë: ${criterion.weight}%</span>
            </div>
            ${inputHTML}
          </div>
        `;
      }).join('');

      container.innerHTML = criteriaHTML;

      // Th√™m event listeners
      addFormEventListeners();

      // Hi·ªÉn th·ªã form
      document.getElementById('loading').style.display = 'none';
      document.getElementById('form-content').style.display = 'block';
    }

    // T·∫°o input cho t·ª´ng lo·∫°i ti√™u ch√≠
    function generateInputForCriterion(criterion) {
      switch (criterion.type) {
        case 'scale_1_5':
          return `
            <div class="input-group">
              <label class="input-label">ƒêi·ªÉm s·ªë (1-5):</label>
              <div class="scale-input">
                <span>1</span>
                <input type="range" 
                       class="scale-slider score-input" 
                       min="1" max="5" step="1" value="3"
                       data-criterion-id="${criterion.criteria_id}">
                <span>5</span>
                <div class="scale-value">3</div>
              </div>
              <div class="scale-labels">
                <span>K√©m</span>
                <span>Trung b√¨nh</span>
                <span>Xu·∫•t s·∫Øc</span>
              </div>
            </div>
            <div class="input-group">
              <label class="input-label">Nh·∫≠n x√©t (t√πy ch·ªçn):</label>
              <textarea class="comment-textarea comment-input" 
                        placeholder="Nh·∫≠p nh·∫≠n x√©t chi ti·∫øt v·ªÅ ti√™u ch√≠ n√†y..."
                        data-criterion-id="${criterion.criteria_id}"></textarea>
            </div>
          `;
        
        case 'text':
          return `
            <div class="input-group">
              <label class="input-label">Nh·∫≠n x√©t:</label>
              <textarea class="comment-textarea comment-input required" 
                        placeholder="Nh·∫≠p ƒë√°nh gi√° chi ti·∫øt..."
                        data-criterion-id="${criterion.criteria_id}"
                        required></textarea>
            </div>
          `;
        
        default:
          return `
            <div class="input-group">
              <label class="input-label">Gi√° tr·ªã:</label>
              <input type="text" class="comment-input" 
                     placeholder="Nh·∫≠p gi√° tr·ªã..."
                     data-criterion-id="${criterion.criteria_id}">
            </div>
          `;
      }
    }

    // Th√™m event listeners cho form
    function addFormEventListeners() {
      // Scale sliders
      document.querySelectorAll('.scale-slider').forEach(slider => {
        slider.addEventListener('input', function() {
          const valueDisplay = this.parentElement.querySelector('.scale-value');
          valueDisplay.textContent = this.value;
          updateReviewData();
          updateProgress();
        });
      });

      // Text inputs
      document.querySelectorAll('.comment-input').forEach(input => {
        input.addEventListener('input', function() {
          updateReviewData();
          updateProgress();
        });
      });

      // Form submission
      document.getElementById('review-form').addEventListener('submit', function(e) {
        e.preventDefault();
        submitReview();
      });

      // Save draft
      document.getElementById('save-draft').addEventListener('click', function() {
        saveDraft();
      });
    }

    // C·∫≠p nh·∫≠t d·ªØ li·ªáu review
    function updateReviewData() {
      reviewData = {};
      
      criteria.forEach(criterion => {
        const scoreInput = document.querySelector(`input[data-criterion-id="${criterion.criteria_id}"].score-input`);
        const commentInput = document.querySelector(`[data-criterion-id="${criterion.criteria_id}"].comment-input`);
        
        reviewData[criterion.criteria_id] = {
          criteria_id: criterion.criteria_id,
          score: scoreInput ? parseInt(scoreInput.value) : undefined,
          comment: commentInput ? commentInput.value.trim() : ''
        };
      });
    }

    // C·∫≠p nh·∫≠t progress
    function updateProgress() {
      updateReviewData();
      
      let completed = 0;
      const total = criteria.length;
      
      criteria.forEach(criterion => {
        const data = reviewData[criterion.criteria_id];
        if (criterion.type === 'scale_1_5') {
          // Cho scale, ch·ªâ c·∫ßn c√≥ score
          if (data && data.score) completed++;
        } else {
          // Cho text, c·∫ßn c√≥ comment
          if (data && data.comment) completed++;
        }
      });
      
      const percentage = total > 0 ? (completed / total) * 100 : 0;
      
      document.getElementById('progress-text').textContent = `${completed}/${total} ti√™u ch√≠`;
      document.getElementById('progress-fill').style.width = `${percentage}%`;
      
      // Enable/disable submit button
      const submitBtn = document.getElementById('submit-review');
      submitBtn.disabled = completed < total;
    }

    // L∆∞u nh√°p
    function saveDraft() {
      updateReviewData();
      
      // L∆∞u v√†o localStorage
      const draftKey = `draft_${currentAssignment.assignment_id}`;
      localStorage.setItem(draftKey, JSON.stringify(reviewData));
      
      showMessage('üìÑ ƒê√£ l∆∞u nh√°p th√†nh c√¥ng!', 'success');
    }

    // Load nh√°p
    function loadDraft() {
      const draftKey = `draft_${currentAssignment.assignment_id}`;
      const draft = localStorage.getItem(draftKey);
      
      if (draft) {
        const draftData = JSON.parse(draft);
        
        // Populate form v·ªõi d·ªØ li·ªáu nh√°p
        Object.keys(draftData).forEach(criteriaId => {
          const data = draftData[criteriaId];
          
          const scoreInput = document.querySelector(`input[data-criterion-id="${criteriaId}"].score-input`);
          const commentInput = document.querySelector(`[data-criterion-id="${criteriaId}"].comment-input`);
          
          if (scoreInput && data.score) {
            scoreInput.value = data.score;
            const valueDisplay = scoreInput.parentElement.querySelector('.scale-value');
            if (valueDisplay) valueDisplay.textContent = data.score;
          }
          
          if (commentInput && data.comment) {
            commentInput.value = data.comment;
          }
        });
        
        updateProgress();
        showMessage('üìÑ ƒê√£ t·∫£i nh√°p tr∆∞·ªõc ƒë√≥!', 'success');
      }
    }

    // Submit review
    async function submitReview() {
      updateReviewData();
      
      // Validate
      let hasErrors = false;
      const errors = [];
      
      criteria.forEach(criterion => {
        const data = reviewData[criterion.criteria_id];
        
        if (criterion.type === 'scale_1_5') {
          if (!data || !data.score) {
            hasErrors = true;
            errors.push(`Ch∆∞a ch·∫•m ƒëi·ªÉm cho ti√™u ch√≠: ${criterion.criteria_name}`);
          }
        } else if (criterion.type === 'text') {
          if (!data || !data.comment) {
            hasErrors = true;
            errors.push(`Ch∆∞a nh·∫≠p nh·∫≠n x√©t cho ti√™u ch√≠: ${criterion.criteria_name}`);
          }
        }
      });
      
      if (hasErrors) {
        showMessage('‚ùå ' + errors.join('<br>'), 'error');
        return;
      }

      // Confirm submission
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp ƒë√°nh gi√° n√†y? Sau khi n·ªôp s·∫Ω kh√¥ng th·ªÉ ch·ªânh s·ª≠a.')) {
        return;
      }

      try {
        // Disable submit button
        const submitBtn = document.getElementById('submit-review');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ ƒêang n·ªôp...';

        // Prepare responses
        const responses = Object.values(reviewData).filter(r => 
          (r.score !== undefined && r.score !== null) || (r.comment && r.comment.trim())
        );

        // Submit to API
        const result = await window.SIRA_API.saveResponse(currentAssignment.assignment_id, responses);

        if (result.success) {
          // X√≥a draft
          const draftKey = `draft_${currentAssignment.assignment_id}`;
          localStorage.removeItem(draftKey);
          
          // Hi·ªÉn th·ªã th√†nh c√¥ng
          showMessage(`‚úÖ ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c n·ªôp th√†nh c√¥ng! (${result.saved_count}/${result.total_count} ph·∫£n h·ªìi)`, 'success');
          
          // Disable form
          document.getElementById('review-form').style.opacity = '0.5';
          document.querySelectorAll('input, textarea, button').forEach(el => el.disabled = true);
          
          // Redirect sau 3 gi√¢y
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 3000);
          
        } else {
          throw new Error(result.message || 'Kh√¥ng th·ªÉ n·ªôp ƒë√°nh gi√°');
        }

      } catch (error) {
        console.error('Submit error:', error);
        showMessage(`‚ùå C√≥ l·ªói khi n·ªôp ƒë√°nh gi√°: ${error.message}`, 'error');
        
        // Re-enable submit button
        const submitBtn = document.getElementById('submit-review');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ N·ªôp ƒë√°nh gi√°';
      }
    }

    // Kh·ªüi t·∫°o trang
    document.addEventListener('DOMContentLoaded', function() {
      loadReviewData().then(() => {
        // Load draft sau khi form ƒë√£ ƒë∆∞·ª£c t·∫°o
        setTimeout(loadDraft, 100);
      });
    });
  </script>
</body>

</html>